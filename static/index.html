<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Kenzies Fridge</title>
<meta name="description" content="Welcome to Kenzies fridge!">
<meta name="viewport" content="width=device-width,initial-scale=1" /> 

<!-- Open Graph / Social -->
<meta property="og:title" content="Kenzies Fridge">
<meta property="og:description" content="Welcome to kenzies fridge!">
<meta property="og:image" content="https://raw.githubusercontent.com/kenzibets/kenztopia/main/static/image/Screenshot%202025-11-07%20233505.png">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Kenzies Fridge">
<meta name="twitter:description" content="Welcome to kenzies fridge!">
<meta name="twitter:image" content="https://raw.githubusercontent.com/kenzibets/kenztopia/main/static/image/Screenshot%202025-11-07%20233505.png">

<link rel="icon" href="https://pngfre.com/wp-content/uploads/monster-energy-drink-37.png" />

<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&family=Nosifer&display=swap" rel="stylesheet">
<style>
:root{
  --accent-green:#0cf04a;
  --muted:#bfc7c3;
  --bg:#070606;
}
/* Base */
html,body{height:100%;margin:0;background:linear-gradient(180deg,#060606,#0b0b0b);color:#fff;font-family:Rubik,system-ui,-apple-system,"Segoe UI",Roboto,Arial;overflow:hidden}
::-webkit-scrollbar { width: 0; height: 0 }
body { scrollbar-width: none; -ms-overflow-style: none; }

/* background + green streak */
body::before{
  content:""; position:fixed; inset:0; z-index:-3;
  background:
    linear-gradient(180deg, rgba(0,0,0,0.55) 0%, rgba(8,8,8,0.85) 100%),
    url('https://source.unsplash.com/1600x900/?grunge,black,wall') center/cover no-repeat;
  mix-blend-mode:multiply; opacity:0.95;
}
body::after{
  content:""; position:fixed; left:-20%; top:-10%; width:140%; height:120%; z-index:-2;
  background: radial-gradient(40% 60% at 10% 20%, rgba(12,240,74,0.06), transparent 8%),
              radial-gradient(30% 60% at 80% 80%, rgba(12,240,74,0.035), transparent 12%);
  filter:blur(18px); pointer-events:none;
}

/* layout */
.wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:28px;overflow:auto}
.card{width:1150px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.45));border-radius:12px;padding:18px;box-shadow:0 28px 80px rgba(0,0,0,0.95);display:grid;grid-template-columns:1fr 440px;gap:18px;border:4px solid rgba(0,0,0,0.7)}
header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding-bottom:6px}
header h1{margin:0;font-size:24px;letter-spacing:1px;font-weight:900;color:var(--accent-green)}
.subtitle{color:var(--muted);font-size:13px}

/* Socials moved to left styling */
.header-left { display:flex; gap:12px; align-items:center; }

/* Social icons (now on left) */
.socials{display:flex;gap:10px;align-items:center}
.social-link{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:8px;background:rgba(255,255,255,0.018);border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s, box-shadow .12s}
.social-link img{width:20px;height:20px;filter:brightness(1.05) saturate(1.1) invert(0);opacity:0.98}
.social-link:hover{transform:translateY(-4px); box-shadow:0 12px 40px rgba(12,240,74,0.12), 0 0 18px rgba(12,240,74,0.18);}

/* neon glow for icons */
.social-link.neon img{filter: drop-shadow(0 6px 14px rgba(12,240,74,0.18)) drop-shadow(0 0 8px rgba(12,240,74,0.22));}
.social-link.neon{box-shadow: 0 6px 20px rgba(12,240,74,0.08), inset 0 0 8px rgba(12,240,74,0.02); border: 1px solid rgba(12,240,74,0.08)}

/* LEADERBOARD BUTTON - moved into left title area, neon green style */
#leaderboardBtn {
  margin-left:12px;
  background: linear-gradient(180deg,#0cf04a,#08a132);
  border:none;
  color:#04220b;
  padding:8px 12px;
  border-radius:10px;
  font-weight:900;
  cursor:pointer;
  box-shadow: 0 8px 30px rgba(12,240,74,0.12), 0 0 18px rgba(12,240,74,0.18), 0 0 40px rgba(12,240,74,0.06) inset;
  text-shadow: 0 1px 0 rgba(0,0,0,0.6);
}
#leaderboardBtn:hover { transform: translateY(-2px); transition: transform .12s; }

/* RAINBET button (beside leaderboard) */
#rainbetBtn{
  margin-left:8px;
  background: linear-gradient(180deg,#00d976,#0ab83f);
  border:none;
  color:#041b09;
  padding:8px 12px;
  border-radius:10px;
  font-weight:900;
  cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;
  box-shadow: 0 8px 30px rgba(12,240,74,0.09), 0 0 18px rgba(12,240,74,0.12);
}
#rainbetBtn img{width:18px;height:18px;display:inline-block}
#rainbetBtn:hover{ transform:translateY(-3px) }

/* BATTLE PANEL — 3-row layout like skin.club (replace previous #caseBattlePanel / #battlePlayers / .battle-card rules) */
#caseBattlePanel {
  padding-top:12px;
  margin-top:12px;
  border-top:1px dashed rgba(255,255,255,0.03);
}

/* Use a responsive 3-row layout: grid will place items into 3 rows and wrap as required.
   Small screens collapse columns automatically. */
#battlePlayers {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  /* make the visible layout appear as three stacked rows on wider screens by
     setting a tall row track and letting items flow in rows */
  grid-auto-rows: minmax(140px, auto);
  grid-auto-flow: row;
  gap: 14px;
  align-items: stretch;
  margin-top: 12px;
}

/* battle card tweaks for consistent sizing in the 3-row grid */
.battle-card {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  background: linear-gradient(180deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02));
  border-radius: 10px;
  padding: 12px;
  min-height: 180px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.45);
  border: 1px solid rgba(255,255,255,0.03);
  transition: transform .18s ease, box-shadow .18s ease;
}

/* preview image area stays centered and scales inside the card */
.battle-card .preview {
  height: 120px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  border-radius:8px;
  background: linear-gradient(180deg, rgba(0,0,0,0.07), rgba(0,0,0,0.02));
}
.battle-card .preview img { max-width:85%; max-height:85%; object-fit:contain; }

/* slight hover pop for interactivity */
.battle-card:hover { transform: translateY(-6px); box-shadow: 0 18px 48px rgba(0,0,0,0.55); }

/* item meta below preview */
.battle-card .meta { margin-top:10px; display:flex;flex-direction:column;gap:6px; }
.battle-card .meta .item-name { font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.battle-card .meta .item-value { font-weight:900; color:var(--accent-green); font-size:16px; }

/* avatar row at bottom, small rounded avatar + name */
.battle-card .player-row { display:flex; align-items:center; gap:10px; margin-top:10px; }
.battle-card .player-avatar { width:44px; height:44px; border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:900;background:rgba(255,255,255,0.02); color:var(--muted) }
.battle-card .player-name { font-weight:800; font-size:13px; color:#fff }


/* board */
.board-area{padding:8px;border-radius:8px;Display:flex;flex-direction:column;gap:12px;align-items:center;position:relative;overflow:visible}
.controls{display:flex;align-items:center;gap:10px;width:100%;justify-content:space-between}
.left-controls{display:flex;gap:12px;align-items:center}
.btn{background:linear-gradient(180deg,#0bf04a,#0a7e2e);border:none;padding:12px 20px;border-radius:10px;color:#050505;font-weight:900;cursor:pointer;box-shadow:0 10px 22px rgba(11,180,60,0.08)}
.small{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
input[type=number]{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;color:var(--muted);border-radius:8px}

/* board grid (5 x 3) */
.board{display:grid;grid-template-columns: repeat(5, 1fr);gap:12px;align-items:stretch;justify-items:stretch;padding:10px;background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.14));border-radius:12px;border-left:10px solid rgba(0,0,0,0.9);position:relative;min-height:360px}
.col{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;position:relative;border-top:6px solid rgba(0,0,0,0.9);transition:transform .18s}
.cell{width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:8px;background:rgba(0,0,0,0.04);border-radius:6px}
.cell img{width:92px;height:92px;object-fit:contain;transition:transform .35s,filter .25s}
.cell .name{font-size:12px;color:var(--muted);margin-top:8px}

/* multiplier overlay per column */
.col .col-mult{position:absolute;left:50%;transform:translateX(-50%);top:8px;font-family:"Nosifer","Rubik",sans-serif;font-size:46px;color:var(--accent-green);pointer-events:none;text-shadow:0 2px 0 rgba(0,0,0,0.9);opacity:0.95;transition:transform .25s,opacity .18s;letter-spacing:6px}
.col .col-mult.small{font-size:28px;top:auto;bottom:12px;opacity:.7}
.col .col-mult.hidden{opacity:0;transform:translateX(-50%) scale(.92)}

/* states */
.col.spinning img{transform:translateY(-6px) scale(.98)}
.col.win{box-shadow:0 12px 44px rgba(12,240,74,0.22), inset 0 0 18px rgba(12,240,74,0.06);transform:translateY(-6px);transition:transform .22s}
.col.bigwin{animation:colBig .9s ease 0s 1}
@keyframes colBig{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}

/* info area */
.info{background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.18));padding:12px;border-radius:8px;display:flex;flex-direction:column;gap:12px}
.balance{font-size:36px;font-weight:900;color:var(--accent-green);letter-spacing:1px}
.muted{color:var(--muted);font-size:13px}
.payout-board{background:rgba(0,0,0,0.25);padding:12px;border-radius:6px;max-height:220px;overflow:auto;font-size:14px;line-height:1.28}
.payout-board img { width:40px;height:40px }
.history{background:rgba(0,0,0,0.2);padding:12px;border-radius:6px;max-height:260px;overflow:auto;font-size:14px;line-height:1.28}
.history-item{display:flex;justify-content:space-between;padding:6px 0;align-items:center;opacity:0;animation:slideIn .32s ease forwards}
@keyframes slideIn{to{opacity:1;transform:none}from{opacity:0;transform:translateY(-8px)}}

/* Win overlay (center) */
.win-overlay {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  z-index: 10000;
  min-width: 360px;
  max-width: 86%;
  background: rgba(8,8,8,0.95);
  color: #fff;
  border-radius: 12px;
  padding: 18px 22px;
  text-align: center;
  box-shadow: 0 30px 80px rgba(0,0,0,0.8);
  pointer-events: none;
  opacity: 0;
}
.win-overlay .title { font-family: Nosifer, Rubik, sans-serif; font-size: 28px; margin: 2px 0; letter-spacing: 2px; color: var(--accent-green); }
.win-overlay .amount { font-weight: 900; font-size: 34px; margin-top: 6px; }
.win-overlay.small { background: linear-gradient(180deg, rgba(0,0,0,0.92), rgba(0,0,0,0.95)); }
.win-overlay.mid { background: linear-gradient(180deg, rgba(6,20,6,0.96), rgba(10,40,10,0.97)); border: 1px solid rgba(12,240,74,0.08); }
.win-overlay.jackpot { background: linear-gradient(180deg, rgba(50,5,5,0.96), rgba(90,10,10,0.98)); border: 2px solid rgba(255,215,0,0.18); }
.win-overlay.maxwin { background: linear-gradient(180deg, rgba(12,60,12,0.96), rgba(12,120,12,0.98)); border: 2px solid rgba(12,240,74,0.22); box-shadow: 0 40px 120px rgba(12,240,74,0.18); color: #dbffd9; }
.win-overlay.show { opacity: 1; transform: translate(-50%, -50%) scale(1); transition: all 560ms cubic-bezier(.2,.9,.2,1); pointer-events: auto; }
@keyframes popScale { 0%{transform: translate(-50%,-50%) scale(0.7)} 60%{transform: translate(-50%,-50%) scale(1.08)} 100%{transform: translate(-50%,-50%) scale(1)} }
.win-overlay.pop { animation: popScale 700ms cubic-bezier(.2,.9,.2,1); }
.win-overlay.pulse { animation: pulse 900ms ease-in-out; }
@keyframes pulse { 0% { transform: translate(-50%,-50%) scale(.9); } 50% { transform: translate(-50%,-50%) scale(1.03); } 100% { transform: translate(-50%,-50%) scale(1); } }

/* music player: compact and playlist scrolls inside box */
.player{display:flex;flex-direction:column;gap:8px;background:rgba(0,0,0,0.12);padding:8px;border-radius:8px;max-height:360px}
.player .playlist{background:rgba(0,0,0,0.06);padding:6px;border-radius:6px;max-height:140px;overflow:auto}
.player .progress{height:8px;background:rgba(255,255,255,0.04);border-radius:999px;position:relative;cursor:pointer}
.player .progress .bar{height:100%;background:linear-gradient(90deg,var(--accent-green),#6ff29a);width:0;border-radius:999px;transition:width .08s linear}
.player .time{font-size:12px;color:var(--muted);min-width:90px;text-align:right}

/* memetopia modal */
.modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:12000; pointer-events:none; opacity:0; transition:all .28s ease; }
.modal-overlay.active { pointer-events:auto; opacity:1; display:flex; }
.modal { background: #0c0c0c; padding:18px 20px; border-radius:10px; color:#fff; min-width:320px; max-width:92%; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,0.6); }
.continue-btn { border: none; padding:10px 16px; border-radius:8px; font-weight:900; cursor:pointer; margin-top:12px; background: linear-gradient(180deg,#0bf04a,#0a7e2e); color:#050505; }
.continue-btn.flash { animation: flashBtn 1200ms infinite; }
@keyframes flashBtn { 0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)} }

/* responsive */
@media (max-width:1200px){ .card{width:95%} .cell img{width:72px;height:72px} }
.hidden{display:none}

/* Leaderboard modal styles (full centered modal) */
#kf-leaderboard-modal .modal { max-width:980px; width:95%; padding:20px 22px; }
.kf-leaderboard-grid { display:grid; grid-template-columns: 1fr 320px; gap:12px; align-items:start; }
.kf-leaderboard-main { background: rgba(0,0,0,0.06); padding:10px; border-radius:8px; max-height:520px; overflow:auto; }
.kf-leaderboard-right { background: rgba(0,0,0,0.04); padding:10px; border-radius:8px; max-height:520px; overflow:auto; }

/* Leaderboard hero header to look like the image */
.kf-leaderboard-hero{
  display:flex;align-items:center;gap:14px;justify-content:space-between;padding:12px 8px 6px;border-bottom:1px solid rgba(255,255,255,0.03);
}
.kf-leaderboard-hero h2{margin:0;font-size:32px;letter-spacing:2px;font-weight:900;color:#fff;text-align:center}
.kf-leaderboard-hero .muted{color:var(--muted);font-size:13px}

/* Table like the image */
.kf-table{width:100%;border-collapse:collapse;margin-top:12px}
.kf-table thead th{font-size:12px;color:var(--muted);text-align:left;padding:12px 12px;border-bottom:1px solid rgba(255,255,255,0.03);font-weight:700}
.kf-table tbody tr{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));}
.kf-table td{padding:12px;border-bottom:1px dashed rgba(255,255,255,0.03);vertical-align:middle;font-size:14px}
.kf-row-left{display:flex;align-items:center;gap:12px;min-width:0}
.kf-avatar{width:36px;height:36px;border-radius:6px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--muted);flex-shrink:0}
.kf-username{font-weight:800;max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kf-user-meta{display:block;color:var(--muted);font-size:12px;margin-top:4px}
.kf-perf{font-weight:900;color:var(--accent-green);font-size:15px}
.kf-perf.negative{color:#ff6b6b}
.kf-center{color:var(--muted);text-align:center;font-weight:700}
.kf-trades{color:var(--muted);text-align:right}

/* highlight current user */
.kf-table tbody tr.me{background: linear-gradient(90deg, rgba(12,240,74,0.03), rgba(255,255,255,0.01));}

/* mobile */
@media (max-width:720px){
  .kf-leaderboard-grid { grid-template-columns: 1fr; }
  .kf-leaderboard-hero h2{font-size:22px}
}

/* sell feet modal specific */
#sellFeetModal .modal { max-width:520px; width:92%; padding:20px; text-align:center; }
#sellFeetModal .title { font-size:20px; color:var(--accent-green); font-weight:900; margin-bottom:6px; }
#sellFeetModal .msg { color:#fff; margin:10px 0; font-size:15px; }
#sellFeetModal .small-muted { color:var(--muted); font-size:13px; margin-top:8px; }
#sellFeetBtn { background: linear-gradient(180deg,#ffb347,#ff7e5f); border: none; color:#050505; font-weight:900; padding:10px 12px; border-radius:8px; cursor:pointer; }
#sellFeetBtn[disabled] { opacity:0.5; cursor:not-allowed; }

/* Rainbet modal animation + styling (overlay fixed and centered) */
#rainbetModal {
  position: fixed;
  inset: 0;
  display: none; /* toggled to flex in JS */
  align-items: center;
  justify-content: center;
  z-index: 15000;
  pointer-events: none;
  opacity: 0;
  transition: opacity .28s ease, transform .28s ease;
}
#rainbetModal.active {
  display: flex;
  pointer-events: auto;
  opacity: 1;
}
.rain-modal { background: linear-gradient(180deg, rgba(4,10,4,0.98), rgba(8,20,8,0.98)); padding:20px 24px; border-radius:12px; box-shadow: 0 30px 120px rgba(6,30,6,0.8); color:#eaffef; max-width:480px; width:92%; text-align:center; transform:translateY(8px); transition:transform .36s cubic-bezier(.2,.9,.2,1); }
#rainbetModal.active .rain-modal { transform: translateY(0); }
.rain-modal .rain-title { font-size:22px; font-weight:900; color:var(--accent-green); letter-spacing:1px; font-family:Nosifer, Rubik, sans-serif; }
.rain-modal .rain-body { margin-top:8px; font-size:15px; color:#dfffe3; }
.rain-modal .rain-code { margin-top:14px; font-weight:900; font-size:20px; padding:10px 12px; border-radius:10px; background:linear-gradient(90deg, rgba(0,0,0,0.08), rgba(0,0,0,0.02)); display:inline-block; color:#04220b; }
.rain-modal .rain-close { margin-top:14px; padding:8px 12px; border-radius:10px; border:none; background:linear-gradient(180deg,#0bf04a,#0a7e2e); cursor:pointer; font-weight:900; color:#050505; }
.rain-modal .rain-logo { width:36px;height:36px;vertical-align:middle;margin-right:8px;border-radius:6px; }

/* animated confetti dots container */
#rainConfetti { position:absolute; inset:0; pointer-events:none; z-index:16000; }

/* tiny glow pulse for emphasis */
@keyframes neonPulse {
  0% { box-shadow: 0 6px 18px rgba(12,240,74,0.06); transform: translateY(0) }
  50% { box-shadow: 0 18px 54px rgba(12,240,74,0.14); transform: translateY(-4px) }
  100% { box-shadow: 0 6px 18px rgba(12,240,74,0.06); transform: translateY(0) }
}
.rain-code.pulse { animation: neonPulse 1200ms ease-in-out infinite; }

/* small helper for accessibility */
.visually-hidden { position:absolute!important; clip:rect(1px,1px,1px,1px); padding:0;border:0;height:1px;width:1px;overflow:hidden;white-space:nowrap }

/* =========================
   CASE OPENING (CSGO-style) CSS
   ========================= */
#caseModal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 22000;
  background: rgba(0,0,0,0.75);
  pointer-events: none;
}
#caseModal.active { display:flex; pointer-events: auto; }
.case-panel {
  width: min(1200px, 96%);
  max-width: 1400px;
  background: linear-gradient(180deg, rgba(8,8,8,0.98), rgba(14,14,14,0.98));
  border-radius: 12px;
  padding: 18px;
  box-shadow: 0 50px 120px rgba(0,0,0,0.8);
  border: 1px solid rgba(12,240,74,0.06);
  position: relative;
  overflow: hidden;
}
.case-top { display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px }
.case-title { font-weight:900;color:var(--accent-green);font-size:20px }
.case-controls { display:flex; gap:8px; align-items:center }
.case-carousel-wrap {
  position: relative;
  height: 160px;
  overflow: hidden;
  border-radius: 10px;
  background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08));
  border: 1px solid rgba(255,255,255,0.03);
}
.case-carousel {
  display:flex;
  align-items:center;
  height: 100%;
  will-change: transform;
  transform: translateX(0);
  transition: transform 0s linear;
}
.case-item {
  width: 160px;
  height: 140px;
  margin: 0 12px;
  flex: 0 0 160px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(255,255,255,0.01));
  border-radius:10px;
  border: 1px solid rgba(255,255,255,0.03);
  text-align:center;
  color:var(--muted);
}
.case-item img { width:84px;height:84px; object-fit:contain; }
.case-item .name { font-size:12px; font-weight:700; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px }
.case-center-marker {
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:180px; height:160px; pointer-events:none;
  border-left:2px dashed rgba(255,255,255,0.06); border-right:2px dashed rgba(255,255,255,0.06);
  box-shadow: inset 0 0 40px rgba(0,0,0,0.35);
}
.case-bottom { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px }
.case-result { font-weight:900; color:var(--accent-green); font-size:18px; min-width:220px; text-align:left }
.case-cta { margin-left:auto }
.case-flag { font-size:12px; padding:6px 10px; border-radius:8px; background:rgba(255,255,255,0.02); color:var(--muted) }

/* small highlight flash to imitate CS:GO glint */
.case-item.glint { animation: glintAnim 900ms linear 1; border-color: rgba(12,240,74,0.18); box-shadow: 0 14px 60px rgba(12,240,74,0.06); }
@keyframes glintAnim {
  0% { filter: brightness(1); transform: scale(1) }
  40% { filter: brightness(1.06); transform: scale(1.03) }
  100% { filter: brightness(1); transform: scale(1) }
}

/* responsive */
@media (max-width:820px){
  .case-item{ width:120px; height:110px; margin:0 8px; }
  .case-carousel-wrap{ height:130px }
  .case-center-marker{ width:140px; height:130px }
}



/* ========================
   LIVE WINS BOX (NEW)
   ======================== */

/* fixed middle-right placement */
#liveWinsBox {
  position: fixed;
  right: 24px;
  top: 50%;
  transform: translateY(-50%);
  width: 300px;
  max-height: 480px;
  z-index: 14000;
  background: linear-gradient(180deg, rgba(0,0,0,0.48), rgba(0,0,0,0.6));
  border-radius: 12px;
  padding: 12px 12px 10px 12px;
  box-shadow: 0 30px 90px rgba(0,0,0,0.7), 0 6px 30px rgba(12,240,74,0.06);
  border: 1px solid rgba(12,240,74,0.08);
  backdrop-filter: blur(6px);
  color: #eafef0;
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 13px;
  align-items: stretch;
}

/* header with centered live dot */
#liveWinsBox .lw-header {
  position: relative;
  padding-top: 10px;
  text-align: center;
}
#liveWinsBox .lw-title {
  font-weight: 900;
  color: var(--accent-green);
  letter-spacing: 1px;
  font-size: 15px;
}
#liveWinsBox .lw-sub { color: var(--muted); font-size: 12px; margin-top:4px; }
/* small inner dot removed (no blinking) */
#liveWinsBox .lw-live-dot::after {
  display: none;
}

/* list of recent events */
#liveWinsList {
  display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:260px;padding-right:6px;
}
.lw-item {
  display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.02);
  box-shadow: 0 8px 18px rgba(0,0,0,0.45);
  font-size: 13px;
}
.lw-item.win { border-left: 4px solid rgba(12,240,74,0.9); }
.lw-item.lose { border-left: 4px solid rgba(255,100,100,0.9); }
.lw-item .left { display:flex;gap:8px;align-items:center;min-width:0 }
.lw-item .ava { width:28px;height:28px;border-radius:6px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--muted);flex-shrink:0; font-size:12px }
.lw-item .nick { font-weight:700; color:#fff; max-width:130px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px }
.lw-item .amt { font-weight:900; color:var(--accent-green); min-width:70px; text-align:right; font-size:13px; }

/* summary block below list */
#liveWinsSummary {
  margin-top:4px;
  padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.12));
  font-size:13px; color:var(--muted);
}
#liveWinsSummary .s-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
#liveWinsSummary .s-name{font-weight:700;color:#fff}

/* small footer controls */
#liveWinsBox .lw-footer { display:flex;gap:8px;align-items:center;justify-content:space-between;padding-top:6px; color:var(--muted); font-size:12px; }

/* responsive tweak to avoid overlapping on small screens */
@media (max-width:900px){
  #liveWinsBox { right: 8px; width: 270px; max-height: 44vh; }
}

/* end live wins */

/* Toast for nickname/save messages */
#kf-toast {
  position: fixed;
  right: 18px;
  bottom: 18px;
  z-index: 20000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-end;
  pointer-events: none;
}
.kf-toast-item {
  pointer-events: auto;
  background: rgba(10,10,10,0.95);
  color: #eaffef;
  border-radius: 8px;
  padding: 10px 14px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  border: 1px solid rgba(12,240,74,0.08);
  font-weight:700;
  min-width: 160px;
  text-align: right;
  transition: transform .28s cubic-bezier(.2,.9,.2,1), opacity .28s;
}
.kf-toast-item.show { transform: translateY(0); opacity: 1; }
.kf-toast-item.hide { transform: translateY(8px); opacity: 0; }

</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="card" role="application" id="card">
    <header>
      <div class="header-left" style="display:flex;align-items:center;gap:12px">
        <div>
          <h1 id="title">Kenzies Frigde <span style="font-size:12px;color:var(--muted);font-weight:600"></span></h1>
          <div class="subtitle">Welcome to kenzies fridge.</div>
        </div>

        <!-- Social icons moved to the left so they aren't off the slot -->
        <div class="socials" id="socialsBar" aria-label="Social links" style="margin-left:6px">
          <a class="social-link neon" href="https://www.instagram.com/mackenzie._.fordd" target="_blank" rel="noopener noreferrer" title="Instagram">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@15.19.0/icons/instagram.svg" alt="Instagram">
          </a>
          <a class="social-link neon" href="https://www.snapchat.com/add/mackenzief805" target="_blank" rel="noopener noreferrer" title="Snapchat">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@15.19.0/icons/snapchat.svg" alt="Snapchat">
          </a>

          <!-- TikTok icons (3 links) -->
          <a class="social-link neon" href="https://www.tiktok.com/@mackenzie._.fordd?_t=ZT-90tB6AaVQuE&_r=1" target="_blank" rel="noopener noreferrer" title="TikTok 1">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@15.19.0/icons/tiktok.svg" alt="TikTok">
          </a>
          <a class="social-link neon" href="https://www.tiktok.com/@kenzibets?_t=ZT-90tB6vEiKp4&_r=1" target="_blank" rel="noopener noreferrer" title="TikTok 2">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@15.19.0/icons/tiktok.svg" alt="TikTok">
          </a>
          <a class="social-link neon" href="https://www.tiktok.com/@kenzii.clips?_t=ZT-90tAxvfgWSF&_r=1" target="_blank" rel="noopener noreferrer" title="TikTok 3">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@15.19.0/icons/tiktok.svg" alt="TikTok">
          </a>

          <a class="social-link neon" href="https://www.youtube.com/@kenzibettz" target="_blank" rel="noopener noreferrer" title="YouTube">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@15.19.0/icons/youtube.svg" alt="YouTube">
          </a>
          <a class="social-link neon" href="https://kick.com/mackenzie-fordd" target="_blank" rel="noopener noreferrer" title="Kick">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@15.19.0/icons/kick.svg" alt="Kick">
          </a>
        </div>


        <button id="signinBtn" class="small" type="button">Sign In</button>
        <button id="leaderboardBtn" class="small" type="button">LEADERBOARD</button>
        <!-- Rainbet button requested (opens animated message) -->
        <button id="rainbetBtn" title="Rainbet — use code shawty" type="button">
          <img src="https://raw.githubusercontent.com/kenzibets/socials/main/rain.png" alt="rain logo" />
          RAINBET
        </button>
      </div>

      <!-- right side simplified -->
      <div style="text-align:right">
        <div id="userArea" style="display:flex;align-items:center;gap:10px"></div>
      </div>
    </header>
<!-- AUTH (login / register) modal -->
<div id="kf-auth-modal" class="modal-overlay" aria-hidden="true" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="kf-auth-title" style="max-width:520px">
    <h3 id="kf-auth-title" style="color:var(--accent-green);margin:0 0 8px 0">Welcome — please sign in</h3>

    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button id="kf-auth-tab-login" class="small" type="button" aria-pressed="true">Login</button>
      <button id="kf-auth-tab-register" class="small" type="button" aria-pressed="false">Register</button>
    </div>

    <div id="kf-auth-forms">
      <!-- LOGIN form -->
      <div id="kf-auth-login" style="display:block">
        <div style="display:flex;flex-direction:column;gap:8px">
          <input id="kf-login-username" type="text" placeholder="Username" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
          <input id="kf-login-password" type="password" placeholder="Password" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="kf-login-btn" class="btn" type="button">Login</button>
          </div>
        </div>
      </div>

      <!-- REGISTER form -->
      <div id="kf-auth-register" style="display:none">
        <div style="display:flex;flex-direction:column;gap:8px">
          <input id="kf-reg-username" type="text" placeholder="Choose a username" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
          <input id="kf-reg-password" type="password" placeholder="Choose a password (min 6)" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
          <input id="kf-reg-nickname" type="text" placeholder="Display nickname (optional)" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="kf-register-btn" class="btn" type="button">Register & Login</button>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px;display:flex;justify-content:center;gap:8px">
      <button id="kf-auth-logout-hidden" class="small" style="display:none">Logout</button>
    </div>
  </div>
</div>
    <!-- LEFT: slot board -->
    <div class="board-area" id="boardArea">
      <div class="controls">
        <div class="left-controls">
          <div>
            <div class="muted">Balance</div>
            <div id="balance" class="balance">5000.00</div>
          </div>
          <div>
            <div class="muted">Bet</div>
            <div id="betWrap"><input id="betInput" type="number" value="10" min="1" step="1" style="width:90px;"></div>
          </div>
          <button id="maxBtn" class="small" type="button">MAX</button>

          <!-- CHANGED: "Reset" button replaced with Sell Feet Pics action -->
          <button id="sellFeetBtn" class="small" title="Sell feet pics (3 uses per 24h)" type="button">SELL FEET PICS</button>

          <!-- MEMES MODE BUTTON (does NOT change colors) -->
          <button id="memesBtn" class="small" type="button">Activate Memes Mode</button>
          <button id="caseBtn" class="small" type="button" title="Open a Monster Case (CSGO-style)">OPEN CASE</button>
        </div>

        <!-- Play area (SPIN + AUTO horizontally) -->
        <div style="display:flex;gap:12px;align-items:center">
          <div style="text-align:center">
            <div class="muted">Play</div>
            <div id="buttonArea" style="margin-top:6px">
              <button id="spinBtn" class="btn" type="button">SPIN</button>
              <!-- auto on the right of spin -->
              <button id="autoBtn" class="small" style="margin-left:12px" type="button">AUTO 10</button>
            </div>
            <div id="lastWin" class="muted" style="margin-top:6px">—</div>
          </div>
        </div>
      </div>

      <div class="board" id="board" aria-hidden="false"></div>

      <div class="particles" id="particles"></div>

      <!-- Minimal memesBox placeholder (kept hidden mostly) -->
      <div id="memesBox" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Memes mode</strong></div>
        </div>
      </div>

    </div>
	
	

    <!-- RIGHT: info + player -->
    <aside class="info" aria-label="Info & Player">
      <div>
        <div class="muted">Payout board</div>
        <div style="font-weight:700">Center-row payouts</div>
      </div>
      <div class="payout-board" id="payoutBoard"></div>

      <div>
        <div class="muted">Spin history</div>
        <div class="history" id="history"></div>
      </div>

      <div>
        <div class="muted">Music Player (background)</div>
        <div class="player">
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small" style="padding:6px 8px;cursor:pointer">
              Select folder
              <input id="folderInput" type="file" webkitdirectory directory multiple style="display:none">
            </label>
            <button id="shuffleBtn" class="small" type="button">Shuffle: OFF</button>
            <button id="loopBtn" class="small" type="button">Loop: ON</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="prevBtn" class="small" type="button">Prev</button>
            <button id="playBtn" class="small" type="button">Play</button>
            <button id="nextBtn" class="small" type="button">Next</button>
            <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7" style="flex:1">
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <div class="progress" id="progress">
                <div class="bar" id="progressBar"></div>
              </div>
            </div>
            <div class="time" id="timeLabel">0:00 / 0:00</div>
          </div>

          <div class="playlist" id="playlist" aria-live="polite" style="min-height:40px"></div>
        </div>
      </div>
    </aside>
  </div>
</div>


</style>

<!-- Live Wins Box (fixed middle-right) -->
<style>
/* Hide live wins box on touch devices / small screens (mobile & iPad) */
@media (hover: none) and (pointer: coarse), (max-width:900px) {
  #liveWinsBox { display: none !important; }
}
</style>

<div id="liveWinsBox" aria-live="polite" aria-atomic="true" role="region" title="Live payouts">
  <div class="lw-header">
    <div class="lw-live-dot" aria-hidden="true"></div>
    <div class="lw-title">LIVE PAYOUTS</div>
    <div class="lw-sub" id="lw-sub">Recent spins & wins</div>
  </div>

  <div id="liveWinsList" aria-hidden="false">
    <!-- items appended here -->
    <div class="lw-item" style="opacity:.55">
      <div class="left"><div class="ava">KF</div><div class="nick">Waiting for activity...</div></div>
      <div class="amt" style="color:var(--muted)">—</div>
    </div>
  </div>

  <div id="liveWinsSummary">
    <div style="font-weight:900;color:var(--accent-green);margin-bottom:6px">Summary</div>
    <div id="lw-summary-rows"><div style="color:var(--muted)">No recent activity</div></div>
  </div>

  <div class="lw-footer">
    <div id="lw-last-refresh" style="font-size:12px;color:var(--muted)">—</div>
    <div>
      <button id="lw-refresh-btn" class="small" type="button">Refresh</button>
    </div>
  </div>
</div>

<!-- REPLACE previous caseModal block with this (includes bet input and battle area) -->
<div id="caseModal" aria-hidden="true">
  <div class="case-panel" role="dialog" aria-modal="true" aria-label="Case opening">
    <div class="case-top">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="case-title" id="caseTitle">Monster Case</div>
        <div style="font-size:12px;color:var(--muted)">Open cases or Battle bots for the pot</div>
      </div>

      <div class="case-controls">
        <div class="case-flag" id="caseModeFlag">Mode: Monster</div>
        <button id="caseToggleMode" class="small" type="button">Toggle Meme Case</button>

        <!-- NEW: Bet input inside modal -->
        <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px;color:var(--muted);font-size:13px">
          Bet:
          <input id="caseBetInput" type="number" min="1" value="10" style="width:96px;padding:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
        </label>

        <div style="width:8px"></div>
        <button id="caseCloseBtn" class="small" type="button">Close</button>
      </div>
    </div>

    <div class="case-carousel-wrap" style="margin-top:8px">
      <div class="case-carousel" id="caseCarousel" style="transform:translateX(0)"></div>
      <div class="case-center-marker" aria-hidden="true"></div>
    </div>

    <div class="case-bottom">
      <div style="display:flex;flex-direction:column;min-width:260px">
        <div class="case-result" id="caseResult">Bet: <strong id="caseBetDisplay">$10</strong></div>
        <div style="font-size:13px;color:var(--muted);margin-top:6px" id="caseInfo">Open one case or run a 1v4 battle against bots for the pot.</div>
      </div>

      <div class="case-cta">
        <button id="caseOpenBtn" class="btn" type="button">OPEN CASE</button>
        <button id="caseOpenX5Btn" class="small" type="button" style="margin-left:8px">OPEN ×5</button>
        <button id="caseBattleBtn" class="small" type="button" style="margin-left:8px">BATTLE 1v4</button>
      </div>
    </div>

    <!-- BATTLE PANEL (hidden until used) -->
    <div id="caseBattlePanel" style="display:none;margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="font-weight:900">Battle</div>
        <div class="muted" id="battleStatus">Idle</div>
      </div>
      <div id="battlePlayers" style="display:flex;gap:12px;margin-top:10px;align-items:stretch"></div>
      <div style="margin-top:10px;font-size:13px;color:var(--muted)" id="battleFooter">Winner takes the pot (4% house rake).</div>
    </div>

  </div>
</div>


<!-- Sell Feet Pics modal -->
<div id="sellFeetModal" class="modal-overlay" aria-hidden="true" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sellFeetTitle">
    <div class="title" id="sellFeetTitle">You sold feet pics...</div>
    <div class="msg" id="sellFeetMsg">You lost your dignity and made $0.00 from selling feet pics... yikes man leave the feet pic business to rudy!</div>
    <div class="small-muted" id="sellFeetInfo"></div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
      <button id="sellFeetClose" class="continue-btn" type="button">OK</button>
    </div>
  </div>
</div>

<!-- Memetopia modal (explanatory text, doesn't show counts) -->
<div id="memetopiaModal" class="modal-overlay" aria-hidden="true" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="memetopiaTitle">
    <h2 id="memetopiaTitle">Memetopia</h2>
    <p id="memetopiaBody">Memetopia replaces standard slot symbols with images (including animated GIFs) and plays win/lose sounds from the repo. Use it to personalize the slot with memes and audio hosted in the repository folders. Press Continue to proceed.</p>
    <button id="memetopiaContinue" class="continue-btn flash" type="button">CONTINUE</button>
  </div>
</div>

<!-- Win overlay (count-up and per-win animation) -->
<div id="winOverlay" class="win-overlay hidden" aria-hidden="true">
  <div class="title" id="winTitle">YOU WIN</div>
  <div class="amount" id="winAmount">$0.00</div>
  <div class="subtitle muted" id="winSub" style="margin-top:6px;font-size:13px"></div>
</div>

<!-- Rainbet modal + confetti container -->
<div id="rainbetModal" aria-hidden="true" style="display:none">
  <div class="rain-modal" role="dialog" aria-modal="true" aria-labelledby="rainTitle">
    <div style="display:flex;align-items:center;justify-content:center;gap:10px">
      <img class="rain-logo" src="https://raw.githubusercontent.com/kenzibets/socials/main/rain.png" alt="rain logo">
      <div class="rain-title" id="rainTitle">Rainbet — 20% Rakeback Boost</div>
    </div>
    <div class="rain-body">Use code <strong>shawty</strong> for a <strong>20% rakeback boost</strong>. Limited time — enjoy the boost!</div>
    <div style="margin-top:12px">
      <div class="rain-code pulse">CODE: <span style="margin-left:8px">SHAWTY</span></div>
    </div>
    <div style="margin-top:14px">
      <button class="rain-close" id="rainCloseBtn" type="button">Got it</button>
    </div>
  </div>
</div>

<!-- AUTH modal (login / register) -->
<div id="authModal" class="modal-overlay" aria-hidden="true" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle" style="max-width:420px">
    <h2 id="authTitle" style="color:var(--accent-green);margin:0 0 8px 0">Sign in / Register</h2>

    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button id="authTabLogin" class="small" type="button">Login</button>
      <button id="authTabRegister" class="small" type="button">Register</button>
    </div>

    <div id="authForms">
      <!-- LOGIN -->
      <div id="authLogin" style="display:none">
        <label class="muted">Username</label>
        <input id="auth_login_username" type="text" placeholder="username" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:8px">

        <label class="muted">Password</label>
        <input id="auth_login_password" type="password" placeholder="password" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:8px">

        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <input id="auth_login_remember" type="checkbox"> Remember me
        </label>

        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
          <button id="auth_login_btn" class="btn" type="button">Sign In</button>
          <button id="auth_close_btn" class="small" type="button">Close</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="authRegister" style="display:none">
        <label class="muted">Username</label>
        <input id="auth_reg_username" type="text" placeholder="username" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:8px">

        <label class="muted">Password (min 6 chars)</label>
        <input id="auth_reg_password" type="password" placeholder="password" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:8px">

        <label class="muted">Nickname (optional)</label>
        <input id="auth_reg_nickname" type="text" placeholder="nickname" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:8px">

        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <input id="auth_reg_remember" type="checkbox"> Remember me
        </label>

        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
          <button id="auth_reg_btn" class="btn" type="button">Register</button>
          <button id="auth_reg_close" class="small" type="button">Close</button>
        </div>
      </div>
    </div>

    <div id="auth_msg" style="margin-top:12px;color:#ffb3b3;display:none"></div>
  </div>
</div>


<script>
(function(){
  // Helper to get/store token (localStorage if remembered, sessionStorage if not)
  function getStoredToken(){
    return sessionStorage.getItem('kf_token') || localStorage.getItem('kf_token') || null;
  }
  function storeToken(token, remember){
    if(!token) { sessionStorage.removeItem('kf_token'); localStorage.removeItem('kf_token'); return; }
    if(remember) {
      localStorage.setItem('kf_token', token);
      sessionStorage.removeItem('kf_token');
    } else {
      sessionStorage.setItem('kf_token', token);
      localStorage.removeItem('kf_token');
    }
  }
  function clearToken(){
    sessionStorage.removeItem('kf_token');
    localStorage.removeItem('kf_token');
    localStorage.removeItem('kf_username');
    localStorage.removeItem('kf_nickname');
  }

  // monkey-patch fetch to include Authorization automatically (safe: only adds header)
  (function(){
    if(window.__kf_fetch_patched) return;
    const _origFetch = window.fetch.bind(window);
    window.fetch = function(resource, init){
      init = init || {};
      init.headers = Object.assign({}, init.headers || {});
      const token = getStoredToken();
      if(token){
        init.headers['Authorization'] = 'Bearer ' + token;
      }
      return _origFetch(resource, init);
    };
    window.__kf_fetch_patched = true;
  })();

  // UI refs
  const signinBtn = document.getElementById('signinBtn');
  const authModal = document.getElementById('authModal');
  const authLogin = document.getElementById('authLogin');
  const authRegister = document.getElementById('authRegister');
  const tabLogin = document.getElementById('authTabLogin');
  const tabRegister = document.getElementById('authTabRegister');
  const authMsg = document.getElementById('auth_msg');

  function showAuthModal(mode='login'){
    if(!authModal) return;
    authModal.style.display = 'flex';
    authModal.classList.add('active');
    authModal.setAttribute('aria-hidden','false');
    if(mode === 'register'){
      authLogin.style.display = 'none';
      authRegister.style.display = 'block';
    } else {
      authLogin.style.display = 'block';
      authRegister.style.display = 'none';
    }
    authMsg.style.display = 'none';
  }
  function hideAuthModal(){
    if(!authModal) return;
    authModal.classList.remove('active');
    authModal.style.display = 'none';
    authModal.setAttribute('aria-hidden','true');
  }

  // Set login/register tab handlers
  if(tabLogin) tabLogin.addEventListener('click', ()=> showAuthModal('login'));
  if(tabRegister) tabRegister.addEventListener('click', ()=> showAuthModal('register'));
  const authClose = document.getElementById('auth_close_btn');
  const authRegClose = document.getElementById('auth_reg_close');
  if(authClose) authClose.addEventListener('click', hideAuthModal);
  if(authRegClose) authRegClose.addEventListener('click', hideAuthModal);

  // sign in button control
  function updateSigninButtonText(){
    const nick = localStorage.getItem('kf_nickname') || sessionStorage.getItem('kf_nickname') || '';
    if(signinBtn){
      signinBtn.textContent = nick ? nick : 'Sign In';
    }
  }

  // on first load, try to auto-validate token & fetch current username -> nickname
  async function tryRestoreSession(){
    const token = getStoredToken();
    if(!token) {
      // show modal to new user immediately
      showAuthModal('login');
      return;
    }
    // We need a username to fetch /api/user/<username> — but backend issues username in login/register responses.
    // If username stored locally, fetch the user record to obtain nickname.
    const storedName = localStorage.getItem('kf_username') || sessionStorage.getItem('kf_username');
    if(storedName){
      try {
        const r = await fetch(`/api/user/${encodeURIComponent(storedName)}`);
        if(r.ok){
          const json = await r.json();
          const nick = (json.nickname || '').slice(0,40);
          if(nick) {
            localStorage.setItem('kf_nickname', nick);
            sessionStorage.setItem('kf_nickname', nick);
          }
          updateSigninButtonText();
          return;
        }
      } catch(e){ /* ignore */ }
    }
    // If we get here, token exists but no username or fetch failed; still set Sign-in to "Sign In" and show modal if needed
    updateSigninButtonText();
  }

  // wire login and register buttons
  const loginBtn = document.getElementById('auth_login_btn');
  const regBtn = document.getElementById('auth_reg_btn');

  async function showError(msg){
    if(!authMsg) return;
    authMsg.style.display = 'block';
    authMsg.style.color = '#ffb3b3';
    authMsg.textContent = msg;
  }

  if(loginBtn){
    loginBtn.addEventListener('click', async function(){
      const username = (document.getElementById('auth_login_username').value || '').trim();
      const password = (document.getElementById('auth_login_password').value || '');
      const remember = document.getElementById('auth_login_remember').checked;
      if(!username || !password) { showError('username and password required'); return; }
      loginBtn.disabled = true;
      try {
        const r = await fetch('/api/login', {
          method: 'POST',
          headers: {'content-type': 'application/json'},
          body: JSON.stringify({ username, password })
        });
        if(!r.ok){
          const err = await r.json().catch(()=>({ detail:'Login failed' }));
          showError(err.detail || 'Login failed');
          return;
        }
        const j = await r.json();
        const token = j.token;
        storeToken(token, remember);
        // save username & nickname locally for UI
        localStorage.setItem(remember? 'kf_username' : 'kf_username', j.username);
        sessionStorage.setItem('kf_username', j.username);
        // Try fetch user to get nickname
        try {
          const ru = await fetch(`/api/user/${encodeURIComponent(j.username)}`);
          if(ru.ok){
            const uj = await ru.json();
            const nick = (uj.nickname || j.username || '').slice(0,40);
            if(remember) localStorage.setItem('kf_nickname', nick);
            sessionStorage.setItem('kf_nickname', nick);
          } else {
            if(remember) localStorage.setItem('kf_nickname', j.username);
            sessionStorage.setItem('kf_nickname', j.username);
          }
        } catch(e){}
        updateSigninButtonText();
        hideAuthModal();
        authMsg.style.display = 'none';
      } catch(e){
        showError('Login failed (network)');
      } finally {
        loginBtn.disabled = false;
      }
    });
  }

  if(regBtn){
    regBtn.addEventListener('click', async function(){
      const username = (document.getElementById('auth_reg_username').value || '').trim();
      const password = (document.getElementById('auth_reg_password').value || '');
      const nickname = (document.getElementById('auth_reg_nickname').value || '').trim().slice(0,40);
      const remember = document.getElementById('auth_reg_remember').checked;
      if(!username || !password || password.length < 6) { showError('username & password (min 6 chars) required'); return; }
      regBtn.disabled = true;
      try{
        const r = await fetch('/api/register', {
          method: 'POST',
          headers: {'content-type': 'application/json'},
          body: JSON.stringify({ username, password, nickname })
        });
        if(!r.ok){
          const err = await r.json().catch(()=>({ detail:'Register failed' }));
          showError(err.detail || 'Register failed');
          return;
        }
        const j = await r.json();
        const token = j.token;
        storeToken(token, remember);
        // Save username and nickname
        if(remember) localStorage.setItem('kf_username', j.username);
        sessionStorage.setItem('kf_username', j.username);
        if(remember) localStorage.setItem('kf_nickname', nickname || j.username);
        sessionStorage.setItem('kf_nickname', nickname || j.username);
        updateSigninButtonText();
        hideAuthModal();
        authMsg.style.display = 'none';
      }catch(e){
        showError('Register failed (network)');
      } finally { regBtn.disabled = false; }
    });
  }

  // Wire sign-in button to open modal and also to allow logout if already signed in
  if(signinBtn){
    signinBtn.addEventListener('click', function(){
      const token = getStoredToken();
      const nick = localStorage.getItem('kf_nickname') || sessionStorage.getItem('kf_nickname') || '';
      if(token && nick){
        // act as a small account menu: clicking will ask to logout
        const doLogout = confirm(`Signed in as ${nick}. Click OK to log out.`);
        if(doLogout){
          clearToken();
          updateSigninButtonText();
          // Also clear local user id used in leaderboard (optional)
          try { localStorage.removeItem('kf_user_id'); } catch(e){}
          // show login modal again
          showAuthModal('login');
        }
      } else {
        showAuthModal('login');
      }
    });
  }

  // on load, initialize sign-in state (pop modal if not logged in)
  document.addEventListener('DOMContentLoaded', function(){
    updateSigninButtonText();
    tryRestoreSession();
  });
})();
</script>


<!-- Toast container -->
<div id="kf-toast" aria-hidden="true"></div>

<!-- Memes & main script -->
<script>
/* Single-file client-side slot machine (static)
   Edits applied:
    - Socials moved to left (header-left).
    - Rainbet modal now uses display:flex when shown so it centers correctly.
    - All previous logic preserved.
    - REMOVED blinking inner dot on LIVE PAYOUTS indicator.
    - ALL visual numbers now use abbreviated letters (K, M, B, T, Qa, Qi, Sx, Sp) for thousand+.
    - IMPORTANT: UI will NEVER fallback to user_id for display; uses 'Anon' instead.
    - When saving a nickname, a toast message "Nickname set to {nick}" is shown.
*/

/* ---------------------------
   NEW: Number abbreviation helpers
   --------------------------- */

// abbreviateNumber: returns a compact string WITHOUT a currency symbol, e.g.:
//   10000 -> "10K", 1500 -> "1.5K", 500 -> "500", 1234567 -> "1.2M"

/* ---- CASE MODAL Z-INDEX PATCH: ensure win overlay (z-index:10000) appears above case modal ----
   Adds temporary z-index lowering when case modal is opened, and restores on close.
   Insert this inside the same IIFE where caseModal / caseBtn / caseCloseBtn are defined.
*/

(function(){
  function isMobileOrIpad(){
    try{
      const ua = navigator.userAgent || '';
      // mobile tokens + iPad + Tablet
      const mobileUA = /Mobi|Android|iPhone|iPad|Tablet/i.test(ua);
      const touchCapable = (navigator.maxTouchPoints && navigator.maxTouchPoints > 1) || ('ontouchstart' in window);
      return mobileUA || touchCapable;
    }catch(e){
      return false;
    }
  }

  function disableLiveWins(){
    const el = document.getElementById('liveWinsBox');
    if(el){
      el.style.display = 'none';
      el.setAttribute('aria-hidden','true');
    }
    // Stop any running polling/interval if the main script set it
    try {
      if (typeof stopLiveWinsPolling === 'function') stopLiveWinsPolling();
    } catch(e){}
    try { if(window._lw_polling){ clearInterval(window._lw_polling); window._lw_polling = null; } } catch(e){}
    // Prevent future starts (monkey-patch)
    try { window.startLiveWinsPolling = function(){ /* disabled on mobile/ipad */ }; } catch(e){}
    try { window.fetchLiveWinsFromServer = function(){ return Promise.resolve(null); }; } catch(e){}
  }

  window.addEventListener('load', function(){
    if(isMobileOrIpad()){
      disableLiveWins();
    }
  }, { once: true });
})();


(function(){
  // store previous custom z (if any) so we can restore
  let _casePrevZ = null;
  function _lowerCaseModalZForWinOverlay(){
    try{
      if(!caseModal) return;
      // remember inline z-index (if present)
      _casePrevZ = caseModal.style.zIndex || '';
      // set below the overlay z-index (win-overlay = 10000), use 9000 to be safe
      caseModal.style.zIndex = '9000';
    }catch(e){ console.warn('lower z failed', e); }
  }
  function _restoreCaseModalZ(){
    try{
      if(!caseModal) return;
      if(_casePrevZ === null || _casePrevZ === '') caseModal.style.zIndex = '22000';
      else caseModal.style.zIndex = _casePrevZ;
      _casePrevZ = null;
    }catch(e){ console.warn('restore z failed', e); }
  }

  // patch the existing handlers where caseModal is opened/closed:
  // (replace or augment the code that shows/closes the modal with these calls)

  // OPEN: when the case modal is shown (caseBtn click)
  const _origCaseBtnHandler = caseBtn && caseBtn._patched;
  if(caseBtn){
    // remove any previous duplicate listener we may have added
    try{ caseBtn.removeEventListener('click', caseBtn._patched); }catch(e){}
    const _handler = function(e){
      e && e.preventDefault && e.preventDefault();
      // lower the modal z so win overlay sits above it
      _lowerCaseModalZForWinOverlay();
      caseModal.classList.add('active'); caseModal.setAttribute('aria-hidden','false');
      // ensure modal bet shows main bet by default
      caseBetInput.value = Math.max(1, Number(betInput.value || 10));
      updateCaseUI();
      // initial small populate
      const pool = buildCasePool();
      populateCarousel(pool, Math.floor(Math.random()*pool.length));
    };
    caseBtn.addEventListener('click', _handler);
    caseBtn._patched = _handler;
  }

  // CLOSE via close button: restore z
  if(caseCloseBtn){
    try{ caseCloseBtn.removeEventListener('click', caseCloseBtn._patched_close); }catch(e){}
    const _closeHandler = function(){
      caseModal.classList.remove('active'); caseModal.setAttribute('aria-hidden','true');
      _restoreCaseModalZ();
    };
    caseCloseBtn.addEventListener('click', _closeHandler);
    caseCloseBtn._patched_close = _closeHandler;
  }

  // CLOSE via backdrop click
  try{
    caseModal.addEventListener('click', function(e){
      if(e.target === caseModal){
        caseModal.classList.remove('active'); caseModal.setAttribute('aria-hidden','true');
        _restoreCaseModalZ();
      }
    });
  }catch(e){}

  // CLOSE via Escape key (ensure we restore z when modal closed by Escape)
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && caseModal.classList.contains('active')){
      caseModal.classList.remove('active'); caseModal.setAttribute('aria-hidden','true');
      _restoreCaseModalZ();
    }
  });

  // Also restore z automatically after modal animations / when you programmatically hide it elsewhere
  // (this is a safe no-op if it's already restored)
  window.__kf_restore_case_z = _restoreCaseModalZ;
})();



function abbreviateNumber(num){
  if(!isFinite(num) || num === null) return '0';
  const sign = num < 0 ? -1 : 1;
  num = Math.abs(num);

  const suffixes = ['', 'K','M','B','T','Qa','Qi','Sx','Sp'];
  let idx = 0;
  while(num >= 1000 && idx < suffixes.length - 1){
    num = num / 1000;
    idx++;
  }
  let str;
  if(idx === 0){
    if(Number.isInteger(num)) str = String(num);
    else str = num.toFixed(2).replace(/\.?0+$/,'');
  } else {
    const roundedOne = Math.round(num * 10) / 10;
    if(roundedOne >= 10 || Number.isInteger(roundedOne)) str = String(Math.round(roundedOne));
    else str = String(roundedOne).replace(/\.?0+$/,'');
  }
  return (sign < 0 ? '-' : '') + str + suffixes[idx];
}

// formatCurrency: returns a string prefixed with $ (e.g., "$10K")
function formatCurrency(v){
  if(!isFinite(Number(v))) return '$0';
  return '$' + abbreviateNumber(Number(v));
}

// formatSignedAbbrev: returns "+10K" or "-5.5K" (no $)
function formatSignedAbbrev(v){
  const sign = (v >= 0) ? '+' : '-';
  return sign + abbreviateNumber(Math.abs(Number(v)));
}

// parse abbreviated string back to numeric (supports K,M,B,T, Qa, Qi, Sx, Sp)
function parseAbbreviated(str){
  if(!str && str !== 0) return 0;
  try{
    let s = String(str).trim();
    s = s.replace(/\$/g,'').replace(/,/g,'').trim();
    const m = s.match(/^([+-])?\s*([\d\.]+)\s*([a-zA-Z]{0,3})$/);
    if(!m) {
      const raw = parseFloat(s);
      return isFinite(raw) ? raw : 0;
    }
    const sign = m[1] === '-' ? -1 : 1;
    const num = parseFloat(m[2]) || 0;
    const suffix = (m[3] || '').toLowerCase();

    const map = {
      '': 1,
      'k': 1e3,
      'm': 1e6,
      'b': 1e9,
      't': 1e12,
      'qa': 1e15,
      'q': 1e15,
      'qi': 1e18,
      'p': 1e18,
      'sx': 1e21,
      's': 1e21,
      'sp': 1e24
    };
    let mult = 1;
    if(suffix){
      if(map[suffix]) mult = map[suffix];
      else {
        const two = suffix.slice(0,2);
        if(map[two]) mult = map[two];
        else {
          const one = suffix.slice(0,1);
          if(map[one]) mult = map[one];
        }
      }
    }
    return sign * num * mult;
  }catch(e){
    return 0;
  }
}

/* ---------------------------
   NEW: Helper to set balance text (keeps underlying numeric balance variable untouched)
   --------------------------- */
function setBalanceTextDisplay(v){
  try{
    const el = document.getElementById('balance');
    if(el) el.textContent = formatCurrency(Number(v));
  }catch(e){}
}

/* ---------------------------
   Toast helper (for nickname saved feedback)
   --------------------------- */
function showToast(message, timeout = 3000){
  try{
    const container = document.getElementById('kf-toast');
    if(!container) return;
    const item = document.createElement('div');
    item.className = 'kf-toast-item hide';
    item.textContent = message;
    container.appendChild(item);
    // force reflow to trigger animation
    requestAnimationFrame(()=> {
      item.classList.remove('hide'); item.classList.add('show');
    });
    setTimeout(()=> {
      item.classList.remove('show'); item.classList.add('hide');
      setTimeout(()=> { if(item && item.parentNode) item.parentNode.removeChild(item); }, 320);
    }, timeout);
  }catch(e){}
}

/* ---------------------------
   Constants (symbols, weights) - tuned for more common small wins and rarer big wins
   --------------------------- */
const symbolImages = [
    'https://github.com/kenzibets/socials/raw/main/green.png',
    'https://github.com/kenzibets/socials/raw/main/red.png',
    'https://github.com/kenzibets/socials/raw/main/white.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-56.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-51.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-50.png',
    'https://pngfre.com/wp-content/uploads/monster-energy-drink-71.png',
    'https://pngfre.com/wp-content/uploads/Monster-8.png',
    'https://pngfre.com/wp-content/uploads/Monster-24.png'
];

const SYMBOLS = [
    {"id": 0, "name": "Green Slash", "img": symbolImages[0], "mult3": 8,  "mult2": 2.0},
    {"id": 1, "name": "Red Slash",   "img": symbolImages[1], "mult3": 6,  "mult2": 1.8},
    {"id": 2, "name": "White Slash", "img": symbolImages[2], "mult3": 5,  "mult2": 1.5},
    {"id": 3, "name": "Monster A",   "img": symbolImages[3], "mult3": 12, "mult2": 2.2},
    {"id": 4, "name": "Monster B",   "img": symbolImages[4], "mult3": 10, "mult2": 2.0},
    {"id": 5, "name": "Monster C",   "img": symbolImages[5], "mult3": 7,  "mult2": 1.4},
    {"id": 6, "name": "Monster D",   "img": symbolImages[6], "mult3": 40, "mult2": 6.0},
    {"id": 7, "name": "Monster E",   "img": symbolImages[7], "mult3": 25, "mult2": 3.5},
    {"id": 8, "name": "Monster F",   "img": symbolImages[8], "mult3": 15, "mult2": 2.5},
];

const WEIGHTED_SYMBOL_IDS = (
  Array(40).fill(0)
  .concat(Array(36).fill(1))
  .concat(Array(30).fill(2))
  .concat(Array(20).fill(3))
  .concat(Array(16).fill(4))
  .concat(Array(12).fill(5))
  .concat(Array(3).fill(6))
  .concat(Array(6).fill(7))
  .concat(Array(10).fill(8))
);

/* Board */
const COLUMNS = 5;
const ROWS = 3;

/* GitHub API endpoints (your repo) */
const GITHUB_API_BASE = 'https://api.github.com/repos/kenzibets/monsterslots/contents';
const MEMES_DIR = 'static/memes';
const AUDIO_WINS_DIR = 'static/audios/wins';
const AUDIO_LOSE_DIR = 'static/audios/audios/lose';

/* App state */
const INITIAL_BALANCE = 5000.00;
let balance = INITIAL_BALANCE;
let autoRunning = false;
let autoLeft = 0;
let winShowing = false;

const balanceEl = document.getElementById('balance');
const betInput = document.getElementById('betInput');
const betWrap = document.getElementById('betWrap');
const spinBtn = document.getElementById('spinBtn');
const autoBtn = document.getElementById('autoBtn');
const lastWin = document.getElementById('lastWin');
const boardEl = document.getElementById('board');
const payoutBoardEl = document.getElementById('payoutBoard');
const historyEl = document.getElementById('history');
const maxBtn = document.getElementById('maxBtn');
const sellFeetBtn = document.getElementById('sellFeetBtn');
const particlesRoot = document.getElementById('particles');

const memesBtn = document.getElementById('memesBtn');
const memetopiaModal = document.getElementById('memetopiaModal');
const memetopiaContinue = document.getElementById('memetopiaContinue');
const memetopiaBody = document.getElementById('memetopiaBody');

const folderInput = document.getElementById('folderInput'); // local music loader
const playlistEl = document.getElementById('playlist');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const vol = document.getElementById('vol');
const loopBtn = document.getElementById('loopBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const timeLabel = document.getElementById('timeLabel');

const winOverlay = document.getElementById('winOverlay');
const winTitle = document.getElementById('winTitle');
const winAmountEl = document.getElementById('winAmount');
const winSub = document.getElementById('winSub');

const sellFeetModal = document.getElementById('sellFeetModal');
const sellFeetMsg = document.getElementById('sellFeetMsg');
const sellFeetInfo = document.getElementById('sellFeetInfo');
const sellFeetClose = document.getElementById('sellFeetClose');

let playlist = []; // background music playlist
let audio = new Audio();
audio.volume = Number(vol.value);
let currentIndex = 0;
let loopAudio = true;
let shuffleAudio = false;
loopBtn.textContent = 'Loop: ON';
shuffleBtn.textContent = 'Shuffle: OFF';

let memeImages = [];
let memeSymbols = [];
let sfxWins = [];
let sfxLose = [];
let memesMode = false;

function setBalance(v){ balance = Math.max(0, Math.round(v*100)/100); setBalanceTextDisplay(balance); window.balance = balance; }
setBalance(balance);

function fmtTime(s){ if(!isFinite(s)) return '0:00'; s = Math.max(0, Math.floor(s)); return Math.floor(s/60) + ':' + (s%60<10 ? '0'+(s%60) : (s%60)); }

function buildBoard(){
  boardEl.innerHTML = '';
  for(let c=0;c<COLUMNS;c++){
    const col = document.createElement('div');
    col.className = 'col';
    col.id = `col-${c}`;
    const mult = document.createElement('div');
    mult.className = 'col-mult hidden';
    mult.id = `col-mult-${c}`;
    mult.textContent = 'X1';
    col.appendChild(mult);
    for(let r=0;r<ROWS;r++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.innerHTML = `<img src="" alt=""><div class="name">---</div>`;
      col.appendChild(cell);
    }
    boardEl.appendChild(col);
  }
}
buildBoard();

function populatePayoutBoard(){
  payoutBoardEl.innerHTML = '';
  if(memesMode && memeSymbols.length){
    const sorted = memeSymbols.slice().sort((a,b)=>b.mult3 - a.mult3);
    for(const s of sorted){
      const row = document.createElement('div');
      row.className = 'payout-row';
      row.style.display = 'flex';
      row.style.justifyContent = 'space-between';
      row.style.alignItems = 'center';
      row.style.padding = '6px 0';
      row.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;min-width:0">
          <img src="${s.img}" style="width:40px;height:40px;object-fit:contain">
          <div style="line-height:1;min-width:0">
            <div style="font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px">${s.winName}</div>
            <div class="muted" style="font-size:12px">3+ center → ${s.mult3}x • pair → ${s.mult2}x</div>
          </div>
        </div>
        <div style="text-align:right"><div class="muted" style="font-size:13px">meme ${s.id}</div></div>
      `;
      payoutBoardEl.appendChild(row);
    }
    const maxRow = document.createElement('div');
    maxRow.style.padding = '8px 0';
    maxRow.style.borderTop = '1px dashed rgba(255,255,255,0.04)';
    maxRow.style.marginTop = '6px';
    maxRow.innerHTML = `<div style="font-weight:900;color:var(--accent-green)">MAX WIN — All slots show distinct memes (bigger than JACKPOT)</div><div class="muted" style="font-size:12px">Triggers when center row contains distinct meme images across all columns.</div>`;
    payoutBoardEl.prepend(maxRow);
  } else {
    const sorted = SYMBOLS.slice().sort((a,b)=>b.mult3 - a.mult3);
    for(const s of sorted){
      const row = document.createElement('div');
      row.className = 'payout-row';
      row.style.display = 'flex';
      row.style.justifyContent = 'space-between';
      row.style.alignItems = 'center';
      row.style.padding = '6px 0';
      row.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;min-width:0">
          <img src="${s.img}" style="width:40px;height:40px;object-fit:contain">
          <div style="line-height:1;min-width:0">
            <div style="font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px">${s.name}</div>
            <div class="muted" style="font-size:12px">3+ center → ${s.mult3}x • pair → ${s.mult2}x</div>
          </div>
        </div>
        <div style="text-align:right"><div class="muted" style="font-size:13px">id ${s.id}</div></div>
      `;
      payoutBoardEl.appendChild(row);
    }
  }
}
populatePayoutBoard();

function randInt(max){ return Math.floor(Math.random()*max); }

function burstAt(x,y,color='rgba(12,240,74,0.95)'){
  const count = 18;
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    p.style.position='absolute';
    p.style.left = `${x}px`; p.style.top = `${y}px`;
    p.style.width='8px'; p.style.height='8px'; p.style.borderRadius='50%';
    p.style.background = color; p.style.opacity = Math.random()*0.9 + 0.3;
    p.style.pointerEvents = 'none'; p.style.mixBlendMode = 'screen';
    particlesRoot.appendChild(p);
    const angle = Math.random()*Math.PI*2;
    const dist = 20 + Math.random()*80;
    const dx = Math.cos(angle)*dist; const dy = Math.sin(angle)*dist;
    p.animate([{ transform: `translate(0px,0px) scale(1)`, opacity: p.style.opacity },{ transform: `translate(${dx}px,${dy}px) scale(.6)`, opacity: 0 }], { duration: 700 + Math.random()*400, easing: 'cubic-bezier(.16,.85,.4,1)'});
    setTimeout(()=> p.remove(), 1200);
  }
}
function cameraShake(intensity = 6){
  const card = document.getElementById('card');
  const dist = intensity;
  card.animate([{ transform: 'translateY(0)' },{ transform: `translateY(-${dist}px)` },{ transform: `translateY(${Math.round(dist/2)}px)` },{ transform: `translateY(-${Math.round(dist/3)}px)` },{ transform: 'translateY(0)' }], { duration: 700, iterations: 1, easing: 'cubic-bezier(.16,.85,.4,1)'});
}

function animateColumn(colIndex, finalColSymbols){
  return new Promise(res=>{
    const colEl = document.getElementById(`col-${colIndex}`);
    const imgs = colEl.querySelectorAll('.cell img');
    const names = colEl.querySelectorAll('.cell .name');
    colEl.classList.add('spinning');
    const ints = [];
    for(let r=0;r<ROWS;r++){
      ints[r] = setInterval(()=>{
        if(memesMode && memeImages.length > 0){
          const pick = memeImages[randInt(memeImages.length)];
          imgs[r].src = pick.url;
          names[r].textContent = pick.displayName;
        } else {
          const s = SYMBOLS[randInt(SYMBOLS.length)];
          imgs[r].src = s.img;
          names[r].textContent = s.name;
        }
      }, 50);
    }
    for(let r=0;r<ROWS;r++){
      const stopAt = 360 + r*90 + Math.random()*120;
      setTimeout(()=>{
        clearInterval(ints[r]);
        if(memesMode && memeImages.length > 0){
          const serverId = finalColSymbols[r].id;
          const memePick = memeSymbols[serverId % memeSymbols.length];
          imgs[r].src = memePick.img;
          names[r].textContent = memePick.winName;
        } else {
          imgs[r].src = finalColSymbols[r].img;
          names[r].textContent = finalColSymbols[r].name;
        }
        imgs[r].animate([{ transform: 'translateY(-8px) scale(.96)' }, { transform: 'translateY(0) scale(1)' }], { duration: 300, easing: 'cubic-bezier(.2,.9,.2,1)' });
      }, stopAt);
    }
    const finishAt = 360 + (ROWS-1)*90 + 220;
    setTimeout(()=>{ colEl.classList.remove('spinning'); res(); }, finishAt+80);
  });
}

function winningIndicesCenter(resp){
  if(!resp || resp.win_type === 'none') return [];
  const center = resp.center_row;
  if(resp.win_type === 'maxwin'){
    return [...Array(center.length).keys()];
  }
  if(resp.win_type === '3x'){
    let winId = null;
    for(let i=0;i<center.length;i++){
      if(center.filter(x=>x===center[i]).length >= 3){ winId = center[i]; break; }
    }
    if(winId===null) return [];
    const idxs = [];
    for(let i=0;i<center.length;i++) if(center[i]===winId) idxs.push(i);
    return idxs;
  } else if(resp.win_type === '2x'){
    let pairId = null;
    const counts = {};
    for(let i=0;i<center.length;i++) counts[center[i]] = (counts[center[i]]||0)+1;
    for(const id in counts) if(counts[id]===2){ pairId = Number(id); break; }
    const idxs = [];
    for(let i=0;i<center.length;i++) if(center[i]===pairId) idxs.push(i);
    return idxs;
  }
  return [];
}

function backgroundAudioAllowed(){
  return true;
}
function sfxAllowed(){
  return !!memesMode;
}

function playRandomWinSfx(){
  if(!sfxAllowed()) return;
  if(sfxWins.length === 0) return;
  const pick = sfxWins[randInt(sfxWins.length)];
  try { new Audio(pick.url).play().catch(()=>{}); } catch(e){}
}
function playRandomLoseSfx(){
  if(!sfxAllowed()) return;
  if(sfxLose.length === 0) return;
  const pick = sfxLose[randInt(sfxLose.length)];
  try { new Audio(pick.url).play().catch(()=>{}); } catch(e){}
}

let _winAnim = { raf: null, start: 0, end: 0, startTime: 0, duration: 0, onComplete: null };
function showWinOverlay(amount, winType, message){
  winShowing = true;
  spinBtn.disabled = true;
  autoBtn.disabled = true;

  winOverlay.classList.remove('hidden','small','mid','jackpot','maxwin','pop','pulse','show');
  void winOverlay.offsetWidth;

  if(winType === 'maxwin'){
    winOverlay.classList.add('maxwin','pop','show');
    winTitle.textContent = message || 'MAX WIN!';
    winSub.textContent = 'ALL DISTINCT MEMES — MEGA HIT';
  } else if(winType === 'jackpot'){
    winOverlay.classList.add('jackpot','pop','show');
    winTitle.textContent = message || 'JACKPOT!';
    winSub.textContent = 'MEGA WIN';
  } else if(winType === 'mid'){
    winOverlay.classList.add('mid','pop','show');
    winTitle.textContent = message || 'BIG WIN';
    winSub.textContent = 'Nice hit!';
  } else {
    winOverlay.classList.add('small','pulse','show');
    winTitle.textContent = message || 'Win';
    winSub.textContent = '';
  }

  _winAnim.start = 0;
  _winAnim.end = Number(amount) || 0;
  const absEnd = Math.abs(_winAnim.end);
  _winAnim.duration = 800;
  if(absEnd >= 200) _winAnim.duration = 1400;
  if(absEnd >= 1000) _winAnim.duration = 2200;
  if(winType === 'jackpot') _winAnim.duration = 3000;
  if(winType === 'maxwin') _winAnim.duration = 3800;
  _winAnim.startTime = null;
  _winAnim.onComplete = () => {
    setTimeout(()=> {
      winOverlay.classList.remove('show');
      setTimeout(()=> {
        winOverlay.classList.add('hidden');
        winShowing = false;
        spinBtn.disabled = false;
        autoBtn.disabled = false;
      }, 500);
    }, 900);
  };

  if(winType === 'maxwin'){
    cameraShake(12);
    const boardRect = boardEl.getBoundingClientRect();
    burstAt(boardRect.width/2, boardRect.height/2, 'rgba(12,240,74,0.98)');
    burstAt(boardRect.width/2, boardRect.height/2, 'rgba(255,215,0,0.95)');
  } else if(winType === 'jackpot'){
    cameraShake(9);
  }

  function step(ts){
    if(!_winAnim.startTime) _winAnim.startTime = ts;
    const elapsed = ts - _winAnim.startTime;
    const t = Math.min(1, elapsed / _winAnim.duration);
    const eased = 1 - Math.pow(1 - t, 3);
    const current = _winAnim.start + (_winAnim.end - _winAnim.start) * eased;
    winAmountEl.textContent = formatCurrency(current);
    if(t < 1 && _winAnim.raf !== 'finished'){
      _winAnim.raf = requestAnimationFrame(step);
    } else {
      _winAnim.raf = null;
      winAmountEl.textContent = formatCurrency(_winAnim.end);
      _winAnim.onComplete && _winAnim.onComplete();
    }
  }
  _winAnim.raf = requestAnimationFrame(step);

  const finishNow = (ev) => {
    if(!_winAnim) return;
    if(_winAnim.raf && _winAnim.raf !== 'finished'){
      if(_winAnim.raf) cancelAnimationFrame(_winAnim.raf);
      _winAnim.raf = 'finished';
      winAmountEl.textContent = formatCurrency(_winAnim.end);
      _winAnim.onComplete && _winAnim.onComplete();
    }
    document.removeEventListener('pointerdown', finishNow, true);
  };
  document.addEventListener('pointerdown', finishNow, true);
}

/* -------------- Spin logic (client-side) -------------- */
function serverlessSpin(bet){
  const grid_ids = [];
  if(memesMode && memeSymbols.length){
    for(let c=0;c<COLUMNS;c++){
      const col = [];
      for(let r=0;r<ROWS;r++){
        col.push( Math.floor(Math.random()*memeSymbols.length) );
      }
      grid_ids.push(col);
    }
  } else {
    for(let c=0;c<COLUMNS;c++){
      const col = [];
      for(let r=0;r<ROWS;r++){
        col.push( WEIGHTED_SYMBOL_IDS[randInt(WEIGHTED_SYMBOL_IDS.length)] );
      }
      grid_ids.push(col);
    }
  }

  const grid_symbols = [];
  for(const col of grid_ids){
    for(const rid of col){
      if(memesMode && memeSymbols.length){
        grid_symbols.push(memeSymbols.find(s => s.id === rid) || memeSymbols[0]);
      } else {
        grid_symbols.push(SYMBOLS.find(s => s.id === rid));
      }
    }
  }

  const center_row_index = Math.floor(ROWS/2);
  const center_ids = [];
  for(let c=0;c<COLUMNS;c++) center_ids.push(grid_ids[c][center_row_index]);

  const counts = {};
  for(const id of center_ids) counts[id] = (counts[id]||0) + 1;

  let payout_multiplier = 0;
  let win_type = "none";
  let winning_symbol = null;

  if(memesMode && memeSymbols.length && (new Set(center_ids)).size === COLUMNS){
    win_type = 'maxwin';
    const involvedMults = center_ids.map(id => (memeSymbols.find(s=>s.id===id) || {mult3:5}).mult3 );
    const avg = involvedMults.reduce((a,b)=>a+b,0)/involvedMults.length;
    payout_multiplier = Math.max( avg * 1.8, avg + 200 );
    winning_symbol = 'ALL MEMES';
  } else {
    if(memesMode && memeSymbols.length){
      for(const [ridStr, cnt] of Object.entries(counts)){
        const rid = Number(ridStr);
        if(cnt >= 3){
          const sym = memeSymbols.find(s => s.id === rid);
          payout_multiplier = sym.mult3;
          win_type = "3x";
          winning_symbol = sym.winName;
          break;
        }
      }
      if(payout_multiplier === 0){
        for(const [ridStr, cnt] of Object.entries(counts)){
          const rid = Number(ridStr);
          if(cnt === 2){
            const sym = memeSymbols.find(s => s.id === rid);
            payout_multiplier = sym.mult2;
            win_type = "2x";
            winning_symbol = sym.winName;
            break;
          }
        }
      }
    } else {
      for(const [ridStr, cnt] of Object.entries(counts)){
        const rid = Number(ridStr);
        if(cnt >= 3){
          const sym = SYMBOLS.find(s => s.id === rid);
          payout_multiplier = sym.mult3;
          win_type = "3x";
          winning_symbol = sym.name;
          break;
        }
      }
      if(payout_multiplier === 0){
        for(const [ridStr, cnt] of Object.entries(counts)){
          const rid = Number(ridStr);
          if(cnt === 2){
            const sym = SYMBOLS.find(s => s.id === rid);
            payout_multiplier = sym.mult2;
            win_type = "2x";
            winning_symbol = sym.name;
            break;
          }
        }
      }
    }
  }

  if(!memesMode && win_type === "2x" && center_ids.includes(6)) payout_multiplier *= 1.25;

  if(payout_multiplier >= 25){
    payout_multiplier = payout_multiplier * (0.78 + Math.random()*0.12);
  } else if(payout_multiplier >= 12){
    payout_multiplier = payout_multiplier * (0.86 + Math.random()*0.12);
  }

  if(memesMode && win_type !== 'none'){
    let passProb = 0.6;
    if(win_type === '2x') passProb = 0.60;
    else if(win_type === '3x') passProb = 0.20;
    else if(win_type === 'maxwin') passProb = 0.05;
    const roll = Math.random();
    if(roll > passProb){
      win_type = 'none';
      payout_multiplier = 0;
      winning_symbol = null;
    } else {
      if(payout_multiplier > 50) payout_multiplier *= 0.9;
    }
  }

  const win_amount = Math.round(bet * payout_multiplier * 100) / 100;

  let message = (win_type === "3x" ? "JACKPOT!" : (win_type === '2x' ? "Nice pair!" : "No win — try again."));
  if(win_type === 'maxwin') message = 'MAX WIN — ALL DISTINCT MEMES!';
  if(memesMode && winning_symbol) message = (win_type === '3x' ? `JACKPOT — ${winning_symbol}` : (win_type === '2x' ? `Nice Pair — ${winning_symbol}` : message));

  return {
    grid: grid_ids,
    symbols: grid_symbols,
    center_row: center_ids,
    bet: bet,
    payout_multiplier: Math.round(payout_multiplier*100)/100,
    win_amount: win_amount,
    win_type: win_type,
    winning_symbol: winning_symbol,
    message: message
  };
}

/* Main spin flow */
async function doSpin(){
  if(winShowing) return;
  spinBtn.disabled = true;
  autoBtn.disabled = true;
  const bet = Math.max(1, Number(betInput.value) || 1);
  if(bet > balance){ spinBtn.disabled = false; autoBtn.disabled = false; return; }
  setBalance(balance - bet);
  lastWin.textContent = '—';

  const resp = serverlessSpin(bet);

  const colPromises = [];
  for(let c=0;c<COLUMNS;c++){
    const finalSymbols = resp.grid[c].map(id => {
      if(memesMode && memeSymbols.length) return memeSymbols.find(s => s.id === id);
      return SYMBOLS.find(s => s.id === id);
    });
    colPromises.push( animateColumn(c, finalSymbols) );
  }

  await Promise.all(colPromises);

  const winIdxs = winningIndicesCenter(resp);
  if(winIdxs.length > 0){
    for(let c=0;c<COLUMNS;c++){
      const multEl = document.getElementById(`col-mult-${c}`);
      if(winIdxs.includes(c)){
        multEl.textContent = resp.win_type === '3x' ? 'X3' : (resp.win_type === 'maxwin' ? 'MAX' : 'X2');
        multEl.classList.remove('hidden'); multEl.classList.remove('small');
        const colEl = document.getElementById(`col-${c}`);
        colEl.classList.add('win');
        if(resp.win_type === '3x' || resp.win_type === 'maxwin'){ colEl.classList.add('bigwin'); setTimeout(()=>colEl.classList.remove('bigwin'),1200); }
        const centerCell = document.querySelector(`#col-${c} .cell:nth-child(${Math.floor(ROWS/2)+1})`);
        const rect = centerCell.getBoundingClientRect();
        const boardRect = boardEl.getBoundingClientRect();
        const x = rect.left + rect.width/2 - boardRect.left;
        const y = rect.top + rect.height/2 - boardRect.top;
        burstAt(x,y, resp.win_type === 'maxwin' ? 'rgba(255,215,0,0.98)' : undefined);
      } else {
        const multEl = document.getElementById(`col-mult-${c}`);
        multEl.textContent = 'X1';
        multEl.classList.remove('hidden'); multEl.classList.add('small');
        setTimeout(()=>multEl.classList.add('hidden'),700);
      }
    }
    if(resp.win_type === '3x'){ cameraShake(9); }
    if(resp.win_type === 'maxwin'){ cameraShake(12); }
    playRandomWinSfx();
  } else {
    for(let c=0;c<COLUMNS;c++){
      const multEl = document.getElementById(`col-mult-${c}`);
      multEl.textContent = 'X1';
      multEl.classList.remove('hidden'); multEl.classList.add('small');
      setTimeout(()=>multEl.classList.add('hidden'),700);
    }
    playRandomLoseSfx();
  }

  if(resp.win_amount > 0){
    setBalance(balance + resp.win_amount);
    lastWin.textContent = `Center multiplier: ${resp.payout_multiplier}x (${resp.win_type})`;

    let winTypeVisual = 'small';
    if(resp.win_type === 'maxwin') winTypeVisual = 'maxwin';
    else if(resp.win_type === '3x') winTypeVisual = 'jackpot';
    else if(resp.win_type === '2x') winTypeVisual = 'mid';
    let msg = resp.message;
    showWinOverlay(resp.win_amount, winTypeVisual, msg);
  } else {
    lastWin.textContent = 'No win';
  }

  const historyRow = document.createElement('div');
  historyRow.className = 'history-item';
  const centerThumbs = resp.center_row.map(id => {
    if(memesMode && memeImages.length>0){
      const m = memeImages[id % memeImages.length];
      return `<img src="${m.url}" style="width:24px;height:24px;object-fit:contain">`;
    } else {
      const s = SYMBOLS.find(x=>x.id===id);
      return `<img src="${s.img}" style="width:24px;height:24px;object-fit:contain">`;
    }
  }).join('');
  historyRow.innerHTML = `<div style="display:flex;gap:6px;align-items:center">${centerThumbs}</div><div style="font-weight:700">${resp.win_amount>0 ? `+${abbreviateNumber(resp.win_amount)}` : `-${abbreviateNumber(bet)}`}</div>`;
  historyEl.prepend(historyRow);
  while(historyEl.childElementCount > 40) historyEl.lastChild.remove();

  setTimeout(()=>{ for(let c=0;c<COLUMNS;c++){ document.getElementById(`col-${c}`).classList.remove('win'); } }, 1800);

  // update live-wins UI and post to server (non-blocking)
  try {
    // prefer username; fallback to kf_user_id if no username saved (so older anonymous flows still work)
    const storedUsername = (localStorage.getItem('kf_username') || sessionStorage.getItem('kf_username') || '').trim();
    let localUsername = storedUsername;
    if(!localUsername){
      // if no username, fallback to existing local user id (preserve backwards compat)
      localUsername = localStorage.getItem('kf_user_id') || sessionStorage.getItem('kf_user_id') ||
                      ('guest-' + Math.random().toString(36).slice(2,10));
      // store fallback so subsequent calls remain consistent
      try{ localStorage.setItem('kf_user_fallback', localUsername); }catch(e){}
    }

    const localNick = (localStorage.getItem('kf_nickname') || sessionStorage.getItem('kf_nickname') || '').slice(0,40);
    const result = resp.win_amount > 0 ? 'win' : 'lose';
    const amtForServer = resp.win_amount > 0 ? resp.win_amount : bet;

    // local UI entry (uses nickname for display, username is used for server)
    const tradeEntry = {
      ts: (new Date()).toISOString(),
      username: localUsername,
      nickname: localNick,
      result: result,
      amount: Math.round(Number(amtForServer || 0) * 100) / 100
    };
    addLiveWinLocal(tradeEntry);
try {
  const storedUsername = (localStorage.getItem('kf_username') || sessionStorage.getItem('kf_username') || '').trim();
  const localNick = (localStorage.getItem('kf_nickname') || sessionStorage.getItem('kf_nickname') || '').slice(0,40);
  const result = resp.win_amount > 0 ? 'win' : 'lose';
  const amtForServer = resp.win_amount > 0 ? resp.win_amount : bet;

  // Add local UI entry (unchanged)
  const tradeEntry = {
    ts: (new Date()).toISOString(),
    username: storedUsername || ('guest-' + Math.random().toString(36).slice(2,10)),
    nickname: localNick,
    result: result,
    amount: Math.round(Number(amtForServer || 0) * 100) / 100
  };
  addLiveWinLocal(tradeEntry);

  // Only attempt to post to server if we have an auth token
  const token = getStoredToken(); // your helper that reads session/local storage
  if (token) {
    (async function(){
      try{
        await fetch('/api/user/me/trade', {
          method: 'POST',
          headers: {'content-type': 'application/json'},
          body: JSON.stringify({ result: result, amount: amtForServer })
        });
      }catch(e){}
    })();
  } else {
    // no auth token: don't POST to server (guest flow)
  }
} catch(e){
  console.warn('live-wins update failed', e);
}
    // send to server using username in path (non-blocking)
    (async function(){
      try{
        await fetch(`/api/user/${encodeURIComponent(localUsername)}/trade`, {
          method: 'POST',
          headers: {'content-type': 'application/json'},
          body: JSON.stringify({ result: result, amount: amtForServer })
        });
      }catch(e){}
    })();
  } catch(e){
    console.warn('live-wins update failed', e);
  }

  if(!winShowing){
    spinBtn.disabled = false;
    autoBtn.disabled = false;
  }
}



/* ---------- controls ---------- */
spinBtn.addEventListener('click', ()=> doSpin());

autoBtn.addEventListener('click', async ()=>{
  if(autoRunning){ autoRunning=false; autoBtn.textContent='AUTO 10'; return; }
  autoRunning = true; autoLeft = 10; autoBtn.textContent = 'STOP AUTO';
  while(autoRunning && autoLeft>0){
    const bet = Math.max(1, Number(betInput.value) || 1);
    if(balance < bet){ autoRunning=false; break; }
    await doSpin();
    autoLeft--;
    await new Promise(r=>setTimeout(r, 520));
  }
  autoRunning = false; autoBtn.textContent='AUTO 10';
});

maxBtn.addEventListener('click', ()=> {
  const b = Math.max(1, Math.floor(balance * 0.1));
  betInput.value = b;
});

/* ---------- SELL FEET PICS feature ---------- */
function _getUserIdForSell(){
  let uid = localStorage.getItem('kf_user_id');
  if(!uid){
    uid = 'u-' + Math.random().toString(36).slice(2,12);
    localStorage.setItem('kf_user_id', uid);
  }
  return uid;
}
function _getSellKey(uid){ return `sellFeet_timestamps_${uid}`; }
function _readSellTimestamps(uid){
  try{
    const raw = localStorage.getItem(_getSellKey(uid));
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr.map(n => Number(n)).filter(n => isFinite(n) && n>0).sort((a,b)=>a-b);
  }catch(e){ return []; }
}
function _writeSellTimestamps(uid, arr){
  try{
    localStorage.setItem(_getSellKey(uid), JSON.stringify(arr.slice().sort((a,b)=>a-b)));
  }catch(e){}
}
function _cleanOldTimestamps(arr){
  const cutoff = Date.now() - 24*60*60*1000;
  return arr.filter(ts => ts >= cutoff);
}
function _hoursMinutesFromMs(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  return { hours: h, minutes: m };
}

async function sellFeetPicsHandler(){
  const uid = _getUserIdForSell();
  let stamps = _readSellTimestamps(uid);
  stamps = _cleanOldTimestamps(stamps);

  if(stamps.length >= 3){
    const oldest = stamps[0];
    const nextAllowed = oldest + 24*60*60*1000;
    const msLeft = nextAllowed - Date.now();
    const pretty = _hoursMinutesFromMs(msLeft);
    const h = pretty.hours, m = pretty.minutes;
    alert(`You've already sold feet pics 3 times in the last 24 hours. Wait ${h}h ${m}m before trying again.`);
    return;
  }

  const randomAmount = Math.round((Math.random() * 5000 + 0.01) * 100) / 100;
  stamps.push(Date.now());
  _writeSellTimestamps(uid, stamps);

  const msg = `You lost your dignity and made ${formatCurrency(randomAmount)} from selling feet pics... yikes man leave the feet pic business to rudy!`;
  sellFeetMsg.textContent = msg;

  const usableLeft = Math.max(0, 3 - stamps.length);
  const nextInfo = (usableLeft > 0) ? `You can do this ${usableLeft} more time(s) in the next 24 hours.` :
    'You have reached the 3 uses limit — wait 24 hours.';
  sellFeetInfo.textContent = nextInfo;

  setBalance(randomAmount);
  try{ localStorage.setItem('kf_balance', String(randomAmount)); }catch(e){}
  sellFeetModal.style.display = 'flex';
  sellFeetModal.classList.add('active');
  sellFeetModal.setAttribute('aria-hidden','false');
  _updateSellFeetButtonState();
}

sellFeetClose.addEventListener('click', ()=>{
  sellFeetModal.classList.remove('active');
  sellFeetModal.style.display = 'none';
  sellFeetModal.setAttribute('aria-hidden','true');
});

function _updateSellFeetButtonState(){
  const uid = _getUserIdForSell();
  let stamps = _readSellTimestamps(uid);
  stamps = _cleanOldTimestamps(stamps);
  const used = stamps.length;
  if(used >= 3){
    sellFeetBtn.disabled = true;
    const oldest = stamps[0];
    const nextAllowed = oldest + 24*60*60*1000;
    const msLeft = nextAllowed - Date.now();
    const pretty = _hoursMinutesFromMs(msLeft);
    sellFeetBtn.title = `Limit reached — try again in ${pretty.hours}h ${pretty.minutes}m`;
  } else {
    sellFeetBtn.disabled = false;
    sellFeetBtn.title = `Sell feet pics (${3-used} uses left in rolling 24h)`;
  }
}

sellFeetBtn.addEventListener('click', async ()=>{
  const ok = confirm('Are you sure? Selling feet pics is for when your broke for a random payout (3 uses per 24h).');
  if(!ok) return;
  await sellFeetPicsHandler();
});

(function initSellFeetState(){
  try{
    _updateSellFeetButtonState();
    setInterval(()=> _updateSellFeetButtonState(), 60*1000);
  }catch(e){ console.warn('sellFeet init failed', e); }
})();

/* ---------- Memes & SFX autoload from GitHub ---------- */
async function fetchGitHubDir(dir){
  const url = `${GITHUB_API_BASE}/${dir}`;
  try {
    const r = await fetch(url);
    if(!r.ok) return [];
    const json = await r.json();
    return json.filter(x=>x && x.type === 'file').map(f=>({ name: f.name, url: f.download_url }));
  } catch(e){
    return [];
  }
}

function buildMemeSymbols(){
  memeSymbols = memeImages.map((m, idx) => {
    const n = Math.max(1, memeImages.length);
    const base = Math.round(Math.max(6, 60 - idx * (50 / n)));
    const mult3 = base;
    const mult2 = Math.max(1.1, Math.round((mult3 / 10) * 10) / 10);
    return {
      id: idx,
      name: m.displayName,
      winName: m.displayName,
      img: m.url,
      mult3: mult3,
      mult2: mult2
    };
  });
}

async function autoloadFromGitHub(){
  const memes = await fetchGitHubDir(MEMES_DIR);
  memeImages = memes.filter(f=>/\.(png|jpe?g|gif|webp)$/i.test(f.name)).map(f=>{
    const displayName = f.name.replace(/\.[^/.]+$/, '').replace(/[-_]+/g,' ').trim();
    return { name: f.name, displayName, url: f.url };
  });

  const wins = await fetchGitHubDir(AUDIO_WINS_DIR);
  const lose = await fetchGitHubDir(AUDIO_LOSE_DIR);
  const audioFilter = (f) => /\.(mp3|m4a|mp4|wav|ogg|webm)$/i.test(f.name);
  sfxWins = wins.filter(audioFilter).map(f=>({ name: f.name, url: f.url }));
  sfxLose = lose.filter(audioFilter).map(f=>({ name: f.name, url: f.url }));

  buildMemeSymbols();

  if(memesMode && memeImages.length){
    for(let c=0;c<COLUMNS;c++){
      const colEl = document.getElementById(`col-${c}`);
      const imgs = colEl.querySelectorAll('.cell img');
      const names = colEl.querySelectorAll('.cell .name');
      for(let r=0;r<ROWS;r++){
        const pick = memeImages[(c + r) % memeImages.length];
        imgs[r].src = pick.url;
        names[r].textContent = pick.displayName;
      }
    }
  }

  populatePayoutBoard();
}

/* ---------- Memes Mode toggle (no color changes) ---------- */
memesBtn.addEventListener('click', async ()=>{
  memesMode = !memesMode;
  const title = document.getElementById('title');
  if(memesMode){
    title.textContent = 'Kenztopia';
    memesBtn.textContent = 'Deactivate Memes Mode';
    await autoloadFromGitHub();
    memetopiaBody.textContent = 'Kenztopia! Welcome to the kenzie vault of memes! Press Continue to close this message.';
    memetopiaModal.style.display = 'flex';
    memetopiaModal.classList.add('active');
    memetopiaModal.setAttribute('aria-hidden', 'false');
  } else {
    title.textContent = 'The Fridge';
    memesBtn.textContent = 'Activate Memes Mode';
    memetopiaModal.style.display = 'none';
    memetopiaModal.classList.remove('active');
    memetopiaModal.setAttribute('aria-hidden', 'true');
    for(let c=0;c<COLUMNS;c++){
      const colEl = document.getElementById(`col-${c}`);
      const imgs = colEl.querySelectorAll('.cell img');
      const names = colEl.querySelectorAll('.cell .name');
      for(let r=0;r<ROWS;r++){
        const s = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
        imgs[r].src = s.img;
        names[r].textContent = s.name;
      }
    }
    populatePayoutBoard();
  }
});

memetopiaContinue.addEventListener('click', ()=>{
  memetopiaModal.style.display = 'none';
  memetopiaModal.classList.remove('active');
  memetopiaModal.setAttribute('aria-hidden','true');
});

/* ---------- Background music player (local-folder loader) ---------- */
folderInput.addEventListener('change', (ev)=>{
  const files = Array.from(ev.target.files || []);
  const audioFiles = files.filter(f=>/\.(mp3|m4a|mp4|wav|ogg|webm)$/i.test(f.name));
  audioFiles.sort((a,b)=>a.name.localeCompare(b.name,'en',{numeric:true}));
  playlist.forEach(p=>{ if(p.file && p.url) URL.revokeObjectURL(p.url); });
  playlist = audioFiles.map(f => ({ name: f.name, url: URL.createObjectURL(f), file: f }));
  renderPlaylist();
  if(playlist.length>0){ currentIndex = 0; loadIndex(0); audio.play().catch(()=>{}); playBtn.textContent='Pause'; }
});

function renderPlaylist(){
  playlistEl.innerHTML = '';
  playlist.forEach((p,i)=>{
    const el = document.createElement('div');
    el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px';
    el.style.gap = '8px';
    el.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:28px;height:28px;background:rgba(255,255,255,0.02);border-radius:4px;display:flex;align-items:center;justify-content:center">${i+1}</div><div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px">${p.name}</div></div><div style="font-size:12px;color:var(--muted)">${i===currentIndex? 'Now' : ''}</div>`;
    el.addEventListener('click', ()=>{ loadIndex(i); audio.play(); playBtn.textContent='Pause'; });
    playlistEl.appendChild(el);
  });
}

function loadIndex(i){
  if(!playlist[i]) return;
  currentIndex = i;
  audio.src = playlist[i].url;
  renderPlaylist();
  updateTimeDisplay();
}

playBtn.addEventListener('click', ()=>{
  if(!audio.src){ if(playlist.length>0) loadIndex(0); else return; }
  if(audio.paused){ audio.play().catch(()=>{}); playBtn.textContent='Pause'; } else { audio.pause(); playBtn.textContent='Play'; }
});

prevBtn.addEventListener('click', ()=>{
  if(playlist.length===0) return;
  if(shuffleAudio){ currentIndex = Math.floor(Math.random()*playlist.length); }
  else currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  loadIndex(currentIndex); audio.play(); playBtn.textContent='Pause';
});
nextBtn.addEventListener('click', ()=>{
  if(playlist.length===0) return;
  if(shuffleAudio){ currentIndex = Math.floor(Math.random()*playlist.length); }
  else currentIndex = (currentIndex + 1) % playlist.length;
  loadIndex(currentIndex); audio.play(); playBtn.textContent='Pause';
});

vol.addEventListener('input', ()=> { 
  audio.volume = Number(vol.value); 
});

loopBtn.addEventListener('click', ()=>{
  loopAudio = !loopAudio; loopBtn.textContent = loopAudio ? 'Loop: ON' : 'Loop: OFF'; audio.loop = loopAudio;
});
shuffleBtn.addEventListener('click', ()=>{
  shuffleAudio = !shuffleAudio; shuffleBtn.textContent = shuffleAudio ? 'Shuffle: ON' : 'Shuffle: OFF';
});

function updateTimeDisplay(){
  const cur = audio.currentTime || 0;
  const dur = audio.duration || 0;
  progressBar.style.width = dur ? ((cur/dur)*100)+'%' : '0%';
  timeLabel.textContent = `${fmtTime(cur)} / ${isFinite(dur) ? fmtTime(dur) : '0:00'}`;
}
audio.addEventListener('timeupdate', updateTimeDisplay);
audio.addEventListener('loadedmetadata', updateTimeDisplay);
audio.addEventListener('ended', ()=>{
  if(loopAudio){ audio.currentTime = 0; audio.play(); return; }
  if(playlist.length>0){
    if(shuffleAudio) currentIndex = Math.floor(Math.random()*playlist.length);
    else currentIndex = (currentIndex + 1) % playlist.length;
    loadIndex(currentIndex); audio.play();
  } else { playBtn.textContent = 'Play'; }
});
progress.addEventListener('click', (e)=>{
  const rect = progress.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const pct = Math.max(0, Math.min(1, x/rect.width));
  if(audio.duration) audio.currentTime = pct * audio.duration;
});

/* ---------------------------
   Initial visuals & float
   --------------------------- */
function initBoardVisuals(){
  for(let c=0;c<COLUMNS;c++){
    const colEl = document.getElementById(`col-${c}`);
    const imgs = colEl.querySelectorAll('.cell img');
    const names = colEl.querySelectorAll('.cell .name');
    for(let r=0;r<ROWS;r++){
      const s = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
      imgs[r].src = s.img; names[r].textContent = s.name;
    }
    const mult = document.getElementById(`col-mult-${c}`);
    mult.textContent = 'X1';
    mult.classList.remove('hidden');
    mult.classList.add('small');
  }
  setTimeout(()=> { for(let c=0;c<COLUMNS;c++) document.getElementById(`col-mult-${c}`).classList.add('hidden'); }, 700);
}
initBoardVisuals();

(function floatCols(){
  const root = boardEl;
  let t = 0;
  function frame(){
    t += 0.01;
    const cols = root.children;
    for(let i=0;i<cols.length;i++){
      const a = Math.sin(t + i*0.25)*1.6;
      cols[i].style.transform = `translateY(${a}px)`;
    }
    requestAnimationFrame(frame);
  }
  frame();
})();

window.addEventListener('beforeunload', ()=>{
  playlist.forEach(p=>{ if(p.url && p.file) URL.revokeObjectURL(p.url); });
});

/* DevTools key-only warning (no spam) */
(function antiInspectKeyOnly(){
  const THROTTLE_MS = 800;
  let lastAction = 0;
  let active = false;

  function now(){ return Date.now(); }

  function showNeonMessage(){
    if (active) return;
    active = true;

    const overlay = document.createElement('div');
    overlay.id = 'anti-inspect-overlay';
    overlay.setAttribute('role','alert');
    Object.assign(overlay.style, {
      position: 'fixed',
      inset: '0',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: '2147483647',
      background: 'rgba(0,0,0,0.85)',
      color: '#39FF14',
      textAlign: 'center',
      padding: '20px',
      boxSizing: 'border-box',
      WebkitUserSelect: 'none',
      userSelect: 'none',
    });

    const box = document.createElement('div');
    Object.assign(box.style, {
      maxWidth: '1400px',
      width: 'calc(100% - 40px)',
      fontFamily: 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial',
      fontSize: 'clamp(18px, 4vw, 44px)',
      lineHeight: '1.1',
      fontWeight: '700',
      letterSpacing: '0.5px',
      textShadow: `
        0 0 6px rgba(57,255,20,0.9),
        0 0 12px rgba(57,255,20,0.7),
        0 0 20px rgba(57,255,20,0.5)
      `,
      transform: 'translateY(-2px)',
      pointerEvents: 'auto'
    });

    box.innerText = 'nuh-uh no inspect element (if this is a false warning ignore this)';

    const hint = document.createElement('div');
    hint.innerText = 'Click to dismiss';
    Object.assign(hint.style, {
      marginTop: '18px',
      fontSize: 'clamp(12px, 1.6vw, 16px)',
      fontWeight: '600',
      opacity: '0.85'
    });

    const inner = document.createElement('div');
    inner.style.textAlign = 'center';
    inner.appendChild(box);
    inner.appendChild(hint);

    overlay.appendChild(inner);
    document.documentElement.appendChild(overlay);

    const prevPointer = document.documentElement.style.pointerEvents;
    document.documentElement.style.pointerEvents = 'none';
    overlay.style.pointerEvents = 'auto';

    function overlayKeyHandler(e){
      try { e.preventDefault(); e.stopImmediatePropagation(); } catch(_){}
    }
    window.addEventListener('keydown', overlayKeyHandler, {capture:true});

    function dismiss(){
      try {
        window.removeEventListener('keydown', overlayKeyHandler, {capture:true});
      } catch(_) {}
      try {
        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
      } catch(_) {}
      document.documentElement.style.pointerEvents = prevPointer || '';
      active = false;
      lastAction = now();
    }

    overlay.addEventListener('click', dismiss, {once:true});
    overlay.addEventListener('touchstart', dismiss, {once:true});
  }

  function triggerWarning(){
    if (now() - lastAction < THROTTLE_MS) return;
    lastAction = now();
    try { showNeonMessage(); } catch(_) {}
  }

  function isDevShortcut(e){
    try {
      const key = (e.key || '').toString().toUpperCase();
      if (key === 'F12') return true;
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && ['I','J','C','P'].includes(key)) return true;
      if ((e.ctrlKey || e.metaKey) && key === 'U') return true;
      return false;
    } catch(_) { return false; }
  }

  window.addEventListener('keydown', (e) => {
    if (e.repeat) return;
    if (active) return;
    if (isDevShortcut(e)){
      try { e.preventDefault(); e.stopImmediatePropagation(); } catch(_) {}
      triggerWarning();
    }
  }, {capture:true});

  window.addEventListener('beforeunload', function(){
    try { } catch(_) {}
  });
})();

/* ---------------------------
   CHEAT CODE: Ctrl+Q -> give 5000 balance, only once per 1 hour per user
--------------------------- */
function _cheatKeyForUser(uid){ return `cheat_ctrl_q_ts_${uid}`; }
function _readCheatTs(uid){
  try{
    const raw = localStorage.getItem(_cheatKeyForUser(uid));
    const n = Number(raw);
    if(!isFinite(n)) return 0;
    return n;
  }catch(e){ return 0; }
}
function _writeCheatTs(uid, ts){
  try{ localStorage.setItem(_cheatKeyForUser(uid), String(ts)); }catch(e){}
}
function _canUseCheat(uid){
  const last = _readCheatTs(uid);
  if(!last) return true;
  const oneHour = 60*60*1000;
  return (Date.now() - last) >= oneHour;
}
function _msLeftForCheat(uid){
  const last = _readCheatTs(uid);
  if(!last) return 0;
  const oneHour = 60*60*1000;
  const left = oneHour - (Date.now() - last);
  return Math.max(0, left);
}
window.addEventListener('keydown', (e) => {
  try{
    const key = (e.key || '').toString().toLowerCase();
    if(key === 'q' && (e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey){
      const activeEl = document.activeElement;
      const tag = activeEl && (activeEl.tagName || '').toUpperCase();
      const isTyping = tag === 'INPUT' || tag === 'TEXTAREA' || activeEl.isContentEditable;
      if(isTyping) return;
      e.preventDefault && e.preventDefault();
      const uid = _getUserIdForSell();
      if(!_canUseCheat(uid)){
        const msLeft = _msLeftForCheat(uid);
        const pretty = _hoursMinutesFromMs(msLeft);
        alert(`Cheat is on cooldown. Try again in ${pretty.hours}h ${pretty.minutes}m.`);
        return;
      }
      setBalance(5000.00);
      try{ localStorage.setItem('kf_balance', String(5000.00)); }catch(e){}
      _writeCheatTs(uid, Date.now());
      alert('Cheat activated: +' + formatCurrency(5000) + ' (one-hour cooldown). Use responsibly.');
    }
  }catch(e){}
});

/* Full case-modal IIFE (complete) — updated so BOTH "monster" and "meme" case openings lose far more often than they win.
   Paste this whole block to replace your existing case-modal IIFE.
   Key change: inside openSingleCase_internal() there's now an extra win-probability gate for BOTH modes
   which makes most drops pay out $0 (loss) unless a random roll passes a relatively low threshold.
   Meme cases are even harder to win than monster cases, but wins remain possible (rare).
*/
(function(){
  const caseBtn = document.getElementById('caseBtn');
  if(!caseBtn) return;

  // DOM refs
  const caseModal = document.getElementById('caseModal');
  const caseCarousel = document.getElementById('caseCarousel');
  const caseOpenBtn = document.getElementById('caseOpenBtn');
  const caseOpenX5Btn = document.getElementById('caseOpenX5Btn');
  const caseCloseBtn = document.getElementById('caseCloseBtn');
  const caseToggleMode = document.getElementById('caseToggleMode');
  const caseTitle = document.getElementById('caseTitle');
  const caseModeFlag = document.getElementById('caseModeFlag');
  const caseBetInput = document.getElementById('caseBetInput');
  const caseBetDisplay = document.getElementById('caseBetDisplay');
  const caseResult = document.getElementById('caseResult');
  const caseInfo = document.getElementById('caseInfo');

  const caseBattleBtn = document.getElementById('caseBattleBtn');
  const caseBattlePanel = document.getElementById('caseBattlePanel');
  const battleStatus = document.getElementById('battleStatus');
  const battlePlayers = document.getElementById('battlePlayers');

  let caseMode = 'monster'; // 'monster' or 'meme'
  let opening = false;

  function updateCaseUI(){
    caseTitle.textContent = caseMode === 'monster' ? 'Monster Case' : 'Memes Case';
    caseModeFlag.textContent = caseMode === 'monster' ? 'Mode: Monster' : 'Mode: Meme';
    caseBetDisplay.textContent = formatCurrency(Number(caseBetInput.value || 1));
    caseInfo.textContent = caseMode === 'meme' ? 'Memes mode uses your meme images + meme audios.' : 'Monster case uses standard symbols.';
    if(caseToggleMode) caseToggleMode.textContent = caseMode === 'meme' ? 'Switch to Monster Case' : 'Toggle Meme Case';
  }

  // Reuse pool functions (same logic as before)
  function buildCasePool(){
    if(caseMode === 'meme' && Array.isArray(memeSymbols) && memeSymbols.length){
      return memeSymbols.map(s => ({
        id: s.id,
        name: s.winName || s.name || ('Meme ' + s.id),
        img: s.img,
        mult3: s.mult3 || 8,
        rarity: Math.max(1, 200 - (s.id || 0) * 6)
      }));
    } else {
      return SYMBOLS.map(s => ({
        id: s.id,
        name: s.name,
        img: s.img,
        mult3: s.mult3 || 6,
        rarity: Math.max(1, Math.round(100 / (s.mult3 || 1)))
      }));
    }
  }

  function pickPrizeIndex(pool){
    const weights = pool.map(p => 1 / Math.max(1, p.rarity));
    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random() * total;
    for(let i=0;i<pool.length;i++){
      r -= weights[i];
      if(r <= 0) return i;
    }
    return pool.length - 1;
  }

  function populateCarousel(pool, chosenIdx){
    caseCarousel.innerHTML = '';
    const totalItems = 64;
    const seq = [];
    for(let i=0;i<totalItems;i++){
      const pick = pool[Math.floor(Math.random() * pool.length)];
      seq.push(pick);
    }
    const insertAt = Math.max(totalItems - 9, 12) + Math.floor(Math.random()*4);
    seq[insertAt] = pool[chosenIdx];
    for(const it of seq){
      const div = document.createElement('div');
      div.className = 'case-item';
      div.innerHTML = `<img src="${it.img}" alt="${it.name}"><div class="name">${it.name}</div>`;
      caseCarousel.appendChild(div);
    }
    caseCarousel.style.transform = 'translateX(0)';
    return { sequenceLength: seq.length, chosenDomIndex: insertAt };
  }

  function animateCarouselToIndex(chosenDomIndex, sequenceLength){
    return new Promise(resolve => {
      const itemEl = caseCarousel.querySelector('.case-item');
      if(!itemEl){ resolve(); return; }
      const itemWidth = itemEl.getBoundingClientRect().width + 24;
      const visibleCenterX = (caseCarousel.parentElement.getBoundingClientRect().width / 2);
      const targetOffset = (chosenDomIndex * itemWidth) + (itemWidth/2) - visibleCenterX;
      const startX = 0;
      const endX = -targetOffset;
      const dist = Math.abs(endX - startX);
      const baseDur = 2100 + Math.min(2400, dist * 4);
      let startTime = null;
      function step(ts){
        if(!startTime) startTime = ts;
        const elapsed = ts - startTime;
        const t = Math.min(1, elapsed / baseDur);
        const eased = 1 - Math.pow(1 - t, 3);
        const curX = startX + (endX - startX) * eased;
        caseCarousel.style.transform = `translateX(${curX}px)`;
        if(t < 1) requestAnimationFrame(step);
        else { caseCarousel.style.transform = `translateX(${endX}px)`; resolve(); }
      }
      requestAnimationFrame(step);
    });
  }

  function revealPrize(chosenDomIndex){
    const items = Array.from(caseCarousel.children);
    items.forEach((el, idx)=> el.classList.remove('glint'));
    const chosenEl = items[chosenDomIndex];
    if(!chosenEl) return null;
    chosenEl.classList.add('glint');
    chosenEl.animate([{ transform:'scale(1)' }, { transform:'scale(1.06)' }, { transform:'scale(1)' }], { duration: 420, easing: 'cubic-bezier(.2,.9,.2,1)' });
    return { name: chosenEl.querySelector('.name') ? chosenEl.querySelector('.name').textContent : '', img: chosenEl.querySelector('img') ? chosenEl.querySelector('img').src : '' };
  }

  // play SFX appropriate for meme mode
  function playCaseSpinSound(){
    try {
      if(caseMode === 'meme' && Array.isArray(sfxLose) && sfxLose.length){
        const pick = sfxLose[Math.floor(Math.random()*sfxLose.length)];
        new Audio(pick.url).play().catch(()=>{});
      } else {
        const a = new Audio();
        a.src = 'data:audio/mp3;base64,//uQx';
      }
    } catch(e){}
  }
  function playCaseWinSound(){
    try {
      if(caseMode === 'meme' && Array.isArray(sfxWins) && sfxWins.length){
        const pick = sfxWins[Math.floor(Math.random()*sfxWins.length)];
        new Audio(pick.url).play().catch(()=>{});
      } else {
        playRandomWinSfx();
      }
    } catch(e){}
  }

  // open a single case (uses bet from caseBetInput). returns { chosenObj, payout }
  async function openSingleCase_internal(forBattle=false){
    if(opening) return null;
    opening = true;
    caseOpenBtn.disabled = true; caseOpenX5Btn.disabled = true; caseBattleBtn.disabled = true;

    const bet = Math.max(1, Number(caseBetInput.value || 1));
    if(!forBattle){
      if(bet > (window.balance || 0)){ showToast('Not enough balance for this case'); opening=false; caseOpenBtn.disabled=false; caseOpenX5Btn.disabled=false; caseBattleBtn.disabled=false; return null; }
      setBalance((window.balance||0) - bet);
    }

    updateCaseUI();

    // Ensure meme assets are loaded when in meme mode
    if(caseMode === 'meme' && (!Array.isArray(memeImages) || memeImages.length === 0)){
      try { await autoloadFromGitHub(); } catch(e){ console.warn('autoload memes failed', e); }
    }

    const pool = buildCasePool();
    const chosenPoolIndex = pickPrizeIndex(pool);
    const meta = populateCarousel(pool, chosenPoolIndex);

    // play some spin sounds while animating (non-blocking)
    playCaseSpinSound();

    await animateCarouselToIndex(meta.chosenDomIndex, meta.sequenceLength);
    await new Promise(r => setTimeout(r, 160));
    const pickInfo = revealPrize(meta.chosenDomIndex);
    const chosen = pool[chosenPoolIndex];

    // compute payout multiplier and amount (same math as earlier approach)
    let payoutMult = chosen.mult3 || 6;
    const rarityFactor = Math.max(1, (120 / (chosen.rarity || 1)));
    payoutMult = Math.round((payoutMult * (1 + (rarityFactor/10) ) + (Math.random()*12)) * 100) / 100;
    if(chosen.rarity <= 3) payoutMult = Math.round((payoutMult * (8 + Math.random()*40)) * 100) / 100;
    let payout = Math.round(bet * payoutMult * 100) / 100;

    /* ---------- UPDATED: easier wins but much smaller payouts ----------
       Behavior:
         - baseWinProb increased so wins are more frequent
         - keepFactor ranges lowered so wins remain small
         - payout is capped to a reasonable multiple of the bet
         - rare items still get a boost to chance, but keepFactor still limits payout
    */
    if(caseMode === 'monster' || caseMode === 'meme'){
      // base win probability — easier wins now
      let baseWinProb = (caseMode === 'monster') ? 0.46 : 0.38; // monster wins ~46%, meme ~38%
      // boost probability for rarer items (rarer items still more likely to yield a payout)
      if(chosen.rarity <= 3) baseWinProb = (caseMode === 'monster') ? 0.72 : 0.56;    // very rare: monster ~72%, meme ~56%
      else if(chosen.rarity <= 8) baseWinProb = (caseMode === 'monster') ? 0.54 : 0.42; // uncommon
      else if(chosen.mult3 >= 12) baseWinProb = (caseMode === 'monster') ? 0.50 : 0.40;  // if mult3 is high

      // tiny random uplift so occasionally you still get bigger surprises
      if(Math.random() < 0.005) baseWinProb = Math.min(0.98, baseWinProb + 0.12);

      const roll = Math.random();
      if(roll > baseWinProb){
        // treat as a loss: zero payout (visual drop still shown)
        payout = 0;
      } else {
        // it's a 'win' — apply stronger dampening so wins are modest
        let keepFactor;
        if(caseMode === 'monster'){
          // monster: wins happen more often, but keep a smaller slice
          keepFactor = 0.25 + Math.random()*0.20; // 0.25–0.45
        } else {
          // meme: slightly smaller keeps on average
          keepFactor = 0.20 + Math.random()*0.20; // 0.20–0.40
        }

        // commons keep less than uncommon/rare
        if(chosen.rarity > 20) keepFactor = keepFactor * 0.85;
        if(chosen.rarity > 60) keepFactor = keepFactor * 0.70;

        // clamp keep factor
        keepFactor = Math.max(0.10, Math.min(0.60, keepFactor));

        // apply keep factor
        payout = Math.round(payout * keepFactor * 100) / 100;

        // additional occasional shrink to create many small wins
        if(Math.random() < 0.12) payout = Math.round(payout * (0.12 + Math.random()*0.38) * 100) / 100;

        // Prevent trivially tiny wins: if payout <= 5% of bet, turn to 0
        if(payout <= bet * 0.05) payout = 0;

        // HARD CAP: keep wins small relative to bet (change multiplier if you want larger cap)
        const maxPayoutCap = Math.round(bet * 1.5 * 100) / 100; // cap at 1.5x the bet
        if(payout > maxPayoutCap) payout = maxPayoutCap;
      }
    }


    // Visual & audio
    try { cameraShake(chosen.rarity <= 3 ? 12 : 6); } catch(e){}
    try { const br = caseCarousel.getBoundingClientRect(); burstAt(br.width/2, br.height/2, chosen.rarity <= 3 ? 'rgba(255,215,0,0.98)' : 'rgba(12,240,74,0.9)'); } catch(e){}
    if(payout > 0) playCaseWinSound(); else { try { if(caseMode === 'meme' && sfxLose.length) { const p = sfxLose[Math.floor(Math.random()*sfxLose.length)]; new Audio(p.url).play().catch(()=>{}); } else playRandomLoseSfx(); } catch(e){} }

    // apply payout (if not battle flow will be applied immediately)
    if(!forBattle && payout > 0){
      setTimeout(()=> {
        setBalance((window.balance || 0) + payout);
        showWinOverlay(payout, (chosen.rarity <= 3 ? 'jackpot' : 'mid'), `Case drop — ${chosen.name}`);
        const hr = document.createElement('div');
        hr.className = 'history-item';
        hr.innerHTML = `<div style="display:flex;gap:6px;align-items:center"><img src="${chosen.img}" style="width:24px;height:24px;object-fit:contain;border-radius:4px"></div><div style="font-weight:700">+${abbreviateNumber(payout)}</div>`;
        historyEl.prepend(hr);
        while(historyEl.childElementCount > 40) historyEl.lastChild.remove();
      }, 420);
    }

    // update result area inside modal (show 0.00 for losses)
    caseResult.innerHTML = `Bet: <strong id="caseBetDisplay">${formatCurrency(bet)}</strong> • Drop: <strong style="color:var(--accent-green)">${chosen.name}</strong> • Value: <strong>${formatCurrency(payout)}</strong>`;

    // re-enable
    setTimeout(()=> {
      opening = false;
      caseOpenBtn.disabled = false; caseOpenX5Btn.disabled = false; caseBattleBtn.disabled = false;
    }, 1100);

    return { chosen, payout, pickInfo, bet };
  }

  // open multiple
  async function openMultipleCases(n){
    for(let i=0;i<n;i++){
      if((window.balance||0) <= 0){ showToast('Balance depleted'); break; }
      await openSingleCase_internal(false);
      await new Promise(r => setTimeout(r, 420));
    }
  }

  // ---- Battle: 1 user vs 4 bots ----
  const BOT_NAMES = ['Rudy','Alex','Ruth','Kenzie'];
  function makeBotAvatar(name){
    const initials = name.slice(0,2).toUpperCase();
    return `<div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--muted);margin-right:8px">${initials}</div>`;
  }

  function renderBattlePlayers(pairs){
    const bp = document.getElementById('battlePlayers') || battlePlayers;
    if(!bp) return;
    bp.innerHTML = '';
    pairs.forEach(function(p, i){
      const wrap = document.createElement('div');
      wrap.className = 'battle-card';
      wrap.innerHTML = `
          <div>
              <div class="preview" aria-hidden="false">
                  <img src="${p.previewImg || ''}" alt="${(p.chosenName || '').replace(/"/g,'&quot;')}">
              </div>
              <div class="meta">
                  <div class="item-name">${p.chosenName || '—'}</div>
                  <div class="item-value" data-value>${p.value ? formatCurrency(p.value) : '—'}</div>
              </div>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
              <div style="display:flex;align-items:center;gap:10px">
                  <div class="player-avatar" aria-hidden="true">${((p.name||'') + '').slice(0,2).toUpperCase()}</div>
                  <div style="display:flex;flex-direction:column;min-width:0">
                      <div class="player-name">${p.name}${p.id==='user' ? ' (you)' : ''}</div>
                      <div style="font-size:12px;color:var(--muted)">${p.id==='bot' ? 'BOT' : 'PLAYER'}</div>
                  </div>
              </div>
              <div style="font-weight:900;color:var(--muted);font-size:12px">#${(p.idx != null) ? p.idx : (i+1)}</div>
          </div>
      `;
      bp.appendChild(wrap);
    });
  }

  function weightedPick(arr, weightFn){
    if(!Array.isArray(arr) || arr.length === 0) return null;
    const weights = arr.map(function(x, i){ try{ return Math.max(0, Number(weightFn(x, i) || 0)); }catch(e){ return 0; } });
    const total = weights.reduce(function(a,b){ return a + b; }, 0);
    if(total <= 0) return arr[Math.floor(Math.random()*arr.length)];
    let r = Math.random() * total;
    for(let i = 0; i < arr.length; i++){
      r -= weights[i];
      if(r <= 0) return arr[i];
    }
    return arr[arr.length - 1];
  }

  async function simulateBattle(){
    if(typeof opening !== 'undefined' && opening) return;
    try{
      opening = true;
    }catch(e){ window.opening = true; }
    try{
      if(caseOpenBtn) caseOpenBtn.disabled = true;
      if(caseOpenX5Btn) caseOpenX5Btn.disabled = true;
      if(caseBattleBtn) caseBattleBtn.disabled = true;
      if(caseBattlePanel) caseBattlePanel.style.display = 'block';
      if(battleStatus) battleStatus.textContent = 'Running...';

      const bet = Math.max(1, Number((caseBetInput && caseBetInput.value) || 1));
      if(bet > (window.balance || 0)){
        showToast && showToast('Not enough balance for battle');
        opening = false;
        if(caseOpenBtn) caseOpenBtn.disabled = false;
        if(caseOpenX5Btn) caseOpenX5Btn.disabled = false;
        if(caseBattleBtn) caseBattleBtn.disabled = false;
        if(battleStatus) battleStatus.textContent = 'Idle';
        return;
      }

      // charge bet up-front
      setBalance && setBalance((window.balance || 0) - bet);

      const pool = (typeof buildCasePool === 'function') ? buildCasePool() : [];
      // players: user + 4 bots
      const players = [{ id:'user', name: (localStorage.getItem('kf_nickname') || 'You'), chosenName:null, value:0, previewImg:null, effective:0 }];
      const BOT_NAMES = ['Rudy','Ruth','Kenzie','Alex'];
      for(let i=0;i<4;i++) players.push({ id:'bot', name: BOT_NAMES[i] || ('Bot'+(i+1)), chosenName:null, value:0, previewImg:null, effective:0 });

      // initial blank render
      renderBattlePlayers(players);

      // sequential openings
      for(let i=0;i<players.length;i++){
        const ply = players[i];
        if(battleStatus) battleStatus.textContent = `Opening for ${ply.name}...`;

        // pick prize index from pool (uses external helper pickPrizeIndex)
        const chosenIdx = (typeof pickPrizeIndex === 'function') ? pickPrizeIndex(pool) : Math.floor(Math.random() * Math.max(1, pool.length));
        const meta = (typeof populateCarousel === 'function') ? populateCarousel(pool, chosenIdx) : { chosenDomIndex: 0, sequenceLength: 10 };
        await new Promise(r=>setTimeout(r, 80));
        if(typeof playCaseSpinSound === 'function') playCaseSpinSound();
        if(typeof animateCarouselToIndex === 'function'){
          await animateCarouselToIndex(meta.chosenDomIndex, meta.sequenceLength);
        } else {
          await new Promise(r=>setTimeout(r, 300 + Math.random()*400));
        }
        if(typeof revealPrize === 'function') revealPrize(meta.chosenDomIndex);
        const chosen = pool[chosenIdx] || { name: 'Unknown', mult3:6, rarity: 10, img: '' };

        // compute raw payout
        let payoutMult = chosen.mult3 || 6;
        const rarityFactor = Math.max(1, (120 / (chosen.rarity || 1)));
        payoutMult = Math.round((payoutMult * (1 + (rarityFactor/10) ) + (Math.random()*12)) * 100) / 100;
        if((chosen.rarity || 99) <= 3){
          payoutMult = Math.round((payoutMult * (8 + Math.random()*40)) * 100) / 100;
        }
        const rawPayout = Math.round(bet * payoutMult * 100) / 100;

        // bias: user nerf, bots boost
        let effectiveValue = rawPayout;
        if(ply.id === 'user'){
          const nerf = 0.03 + Math.random()*0.05; // 3% - 8%
          effectiveValue = Math.round(rawPayout * nerf * 100) / 100;
        } else {
          const botBoost = 1.3 + Math.random()*1.6; // 1.3x - 2.9x
          effectiveValue = Math.round(rawPayout * botBoost * 100) / 100;
        }

        ply.chosenName = chosen.name || ('Item #' + chosenIdx);
        ply.value = rawPayout;
        ply.effective = effectiveValue;
        ply.previewImg = chosen.img || '';

        renderBattlePlayers(players);

        // brief reveal pause
        await new Promise(r => setTimeout(r, 650));
      }

      // choose winner by weighted pick on effective values
      const totalEffective = players.reduce((s,p)=> s + Math.max(0, p.effective || 0), 0);
      let winner;
      if(totalEffective <= 0){
        let maxVal = Math.max(...players.map(p=>p.value||0));
        const top = players.filter(p=> (p.value||0) === maxVal);
        winner = top[Math.floor(Math.random()*top.length)];
      } else {
        winner = weightedPick(players, function(p){ return Math.max(0, p.effective || 0); });
      }

      // pot and rake
      const pot = players.reduce(function(s,p){ return s + (p.value || 0); }, 0);
      const rake = Math.round(pot * 0.04 * 100) / 100;
      const award = Math.round((pot - rake) * 100) / 100;

      if(battleStatus) battleStatus.textContent = `Winner: ${winner.name}${winner.id==='user' ? ' (you) — UNBELIEVABLE!' : ''} • Pot ${formatCurrency(pot)} • Award ${formatCurrency(award)}`;

      if(winner.id === 'user'){
        setTimeout(function(){
          setBalance && setBalance((window.balance || 0) + award);
          if(typeof playCaseWinSound === 'function') playCaseWinSound();
          if(typeof showWinOverlay === 'function') showWinOverlay(award, 'jackpot', `Battle win — ${winner.chosenName}`);
        }, 480);
      } else {
        setTimeout(function(){
          try {
            if(typeof caseMode !== 'undefined' && caseMode === 'meme' && Array.isArray(sfxLose) && sfxLose.length){
              new Audio(sfxLose[Math.floor(Math.random()*sfxLose.length)].url).play().catch(()=>{});
            }
          }catch(e){}
          if(typeof showWinOverlay === 'function') showWinOverlay(0, 'small', `You lost — ${winner.name} won the pot`);
        }, 420);
      }

      // restore UI
      setTimeout(function(){
        opening = false;
        if(caseOpenBtn) caseOpenBtn.disabled = false;
        if(caseOpenX5Btn) caseOpenX5Btn.disabled = false;
        if(caseBattleBtn) caseBattleBtn.disabled = false;
        if(battleStatus) battleStatus.textContent = 'Idle';
      }, 1400);

    }catch(err){
      console.error('simulateBattle error', err);
      opening = false;
      if(caseOpenBtn) caseOpenBtn.disabled = false;
      if(caseOpenX5Btn) caseOpenX5Btn.disabled = false;
      if(caseBattleBtn) caseBattleBtn.disabled = false;
      if(battleStatus) battleStatus.textContent = 'Idle';
      showToast && showToast('Battle failed (see console)');
    }
  }

  // wiring
  caseBtn.addEventListener('click', async (e)=>{
    e && e.preventDefault && e.preventDefault();
    if(caseMode === 'meme' && (!Array.isArray(memeImages) || memeImages.length === 0)){
      try{ await autoloadFromGitHub(); }catch(e){ console.warn('autoload on open failed', e); }
    }
    caseModal.classList.add('active'); caseModal.setAttribute('aria-hidden','false');
    caseBetInput.value = Math.max(1, Number(betInput.value || 10));
    updateCaseUI();
    const pool = buildCasePool();
    populateCarousel(pool, Math.floor(Math.random()*pool.length));
  });

  caseCloseBtn.addEventListener('click', ()=>{
    caseModal.classList.remove('active'); caseModal.setAttribute('aria-hidden','true');
  });
  caseModal.addEventListener('click', function(e){
    if(e.target === caseModal){ caseModal.classList.remove('active'); caseModal.setAttribute('aria-hidden','true'); }
  });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && caseModal.classList.contains('active')) { caseModal.classList.remove('active'); caseModal.setAttribute('aria-hidden','true'); } });

  // NEW: async toggle that loads memes & sfx on-demand and updates UI
  caseToggleMode.addEventListener('click', async ()=>{
    caseMode = (caseMode === 'monster') ? 'meme' : 'monster';
    if(caseMode === 'meme'){
      try{
        memesMode = true;
        if(!Array.isArray(memeImages) || memeImages.length === 0){
          await autoloadFromGitHub();
        } else {
          buildMemeSymbols();
        }
      }catch(err){
        console.warn('failed to autoload memes', err);
      }
    } else {
      memesMode = false;
    }
    updateCaseUI();
    try{
      const pool = buildCasePool();
      populateCarousel(pool, Math.floor(Math.random()*pool.length));
    }catch(e){ console.warn('repopulate after toggle failed', e); }
  });

  caseOpenBtn.addEventListener('click', async ()=> { await openSingleCase_internal(false); });
  caseOpenX5Btn.addEventListener('click', async ()=> { await openMultipleCases(5); });

  caseBattleBtn.addEventListener('click', async ()=> {
    if(typeof simulateBattle === 'function') await simulateBattle();
    else console.warn('simulateBattle not defined in this scope');
  });

  // update UI when modal bet changes
  caseBetInput.addEventListener('input', updateCaseUI);

  // expose debug
  window.__kf_case_open_single = openSingleCase_internal;
})();



/* ---------------------------
   Initializations
   --------------------------- */
(function initBoardAndState(){
  try{
    const localBal = localStorage.getItem('kf_balance');
    if(localBal !== null){
      setBalance(Number(localBal));
    } else {
      setBalance(INITIAL_BALANCE);
      try{ localStorage.setItem('kf_balance', String(INITIAL_BALANCE)); }catch(e){}
    }
  }catch(e){
    setBalance(INITIAL_BALANCE);
  }
})();

setInterval(()=> _updateSellFeetButtonState(), 60*1000);



/* ---------------------------
   LIVE WINS / leaderboard related functions
   - IMPORTANT: never use user_id as nickname in UI
--------------------------- */

/**
 * addLiveWinLocal(entry)
 * - entry: { ts, user_id, nickname, result, amount }
 * Adds the entry to the live wins box UI (prepended).
 * NOTE: This function will NOT display user_id as nickname. If nickname is empty, displays "Anon".
 */
function addLiveWinLocal(entry){
  try{
    const list = document.getElementById('liveWinsList');
    if(!list) return;
    const row = document.createElement('div');
    row.className = 'lw-item ' + (entry.result === 'win' ? 'win' : 'lose');
    // never use user_id as nickname in UI
    const rawNick = (entry.nickname || '').trim();
    const nick = rawNick.length ? rawNick : 'Anon';
    const ava = (nick.trim().length ? nick.slice(0,2).toUpperCase() : 'AN');
    const amt = Number(entry.amount || 0);
    const amtText = (entry.result === 'win') ? `+${abbreviateNumber(amt)}` : `-${abbreviateNumber(amt)}`;
    row.innerHTML = `<div class="left"><div class="ava">${ava}</div><div class="nick" title="${nick}">${nick}</div></div><div class="amt">${amtText}</div>`;
    list.prepend(row);
    while(list.childElementCount > 18) list.lastChild.remove();
    computeAndRenderLiveSummaryFromUI();
  }catch(e){ console.warn('addLiveWinLocal', e); }
}



/**
 * computeAndRenderLiveSummaryFromUI()
 */
function computeAndRenderLiveSummaryFromUI(){
  try{
    const list = document.getElementById('liveWinsList');
    if(!list) return;
    const rows = Array.from(list.children);
    const map = {};
    rows.forEach(r => {
      const nick = (r.querySelector('.nick') && r.querySelector('.nick').textContent.trim()) || '';
      const amtEl = r.querySelector('.amt');
      const raw = amtEl ? amtEl.textContent.replace(/\s/g,'') : '0';
      const val = parseAbbreviated(raw) || 0;
      const isWin = r.classList.contains('win');
      let delta = val;
      if(raw && raw[0] === '+') delta = Math.abs(val);
      else if(raw && raw[0] === '-') delta = -Math.abs(val);
      else delta = isWin ? Math.abs(val) : -Math.abs(val);
      const s = map[nick] || { net:0, wins:0, losses:0, trades:0 };
      s.net = Math.round((s.net + delta)*100)/100;
      if(isWin) s.wins++; else s.losses++;
      s.trades++;
      map[nick] = s;
    });
    const entries = Object.entries(map).map(([nick, stats]) => ({ nick, ...stats }));
    entries.sort((a,b) => Math.abs(b.net) - Math.abs(a.net));
    const rowsOut = entries.slice(0,5);
    const container = document.getElementById('lw-summary-rows');
    container.innerHTML = '';
    if(rowsOut.length === 0){
      container.innerHTML = '<div style="color:var(--muted)">No recent activity</div>';
      return;
    }
    rowsOut.forEach(e => {
      const div = document.createElement('div');
      div.className = 's-row';
      const netColor = e.net >= 0 ? 'var(--accent-green)' : '#ff6b6b';
      div.innerHTML = `<div class="s-name">${e.nick}</div><div style="text-align:right"><div style="color:${netColor};font-weight:700">${e.net>=0?'+':'-'}${formatCurrency(Math.abs(e.net))}</div><div class="muted" style="font-size:11px">${e.wins}W ${e.losses}L</div></div>`;
      container.appendChild(div);
    });
  }catch(e){ console.warn('computeAndRenderLiveSummaryFromUI', e); }
}

/**
 * fetchLiveWinsFromServer(limit)
 * - fetches /api/live-wins?limit=N and updates UI (full replace)
 * NOTE: Will not display user_id as nickname; falls back to 'Anon'.
 */
let _lw_polling = null;
async function fetchLiveWinsFromServer(limit = 12){
  try{
    const r = await fetch(`/api/live-wins?limit=${encodeURIComponent(limit)}`);
    if(!r.ok) return;
    const json = await r.json();
    if(!json) return;
    const recent = json.recent_trades || [];
    const list = document.getElementById('liveWinsList');
    if(!list) return;
    list.innerHTML = '';
    recent.slice(0,18).forEach(entry => {
      const row = document.createElement('div');
      row.className = 'lw-item ' + (entry.result === 'win' ? 'win' : 'lose');
      // IMPORTANT: never display user_id as nickname
      const nickRaw = (entry.nickname || '').trim();
      const nick = nickRaw.length ? nickRaw : 'Anon';
      const ava = (nick.trim().length ? nick.slice(0,2).toUpperCase() : 'AN');
      const amt = Number(entry.amount || 0);
      const amtText = (entry.result === 'win') ? `+${abbreviateNumber(amt)}` : `-${abbreviateNumber(amt)}`;
      row.innerHTML = `<div class="left"><div class="ava">${ava}</div><div class="nick" title="${nick}">${nick}</div></div><div class="amt">${amtText}</div>`;
      list.appendChild(row);
    });
    const container = document.getElementById('lw-summary-rows');
    container.innerHTML = '';
    if(json.summary && typeof json.summary === 'object'){
      const arr = Object.entries(json.summary).map(([nick, s]) => ({ nick, ...s }));
      arr.sort((a,b) => Math.abs(b.net) - Math.abs(a.net));
      arr.slice(0,5).forEach(e => {
        const div = document.createElement('div');
        const netColor = e.net >= 0 ? 'var(--accent-green)' : '#ff6b6b';
        div.className = 's-row';
        div.innerHTML = `<div class="s-name">${e.nick}</div><div style="text-align:right"><div style="color:${netColor};font-weight:700">${e.net>=0?'+':'-'}${formatCurrency(Math.abs(e.net))}</div><div class="muted" style="font-size:11px">${e.wins||0}W ${e.losses||0}L</div></div>`;
        container.appendChild(div);
      });
    } else {
      computeAndRenderLiveSummaryFromUI();
    }
    const lf = document.getElementById('lw-last-refresh');
    lf.textContent = `Updated ${new Date().toLocaleTimeString()}`;
  }catch(e){}
}

function startLiveWinsPolling(){
  fetchLiveWinsFromServer(12);
  _lw_polling = setInterval(()=> fetchLiveWinsFromServer(12), 3000);
}
function stopLiveWinsPolling(){
  if(_lw_polling) clearInterval(_lw_polling);
  _lw_polling = null;
}

const lwRefreshBtn = document.getElementById('lw-refresh-btn');
if(lwRefreshBtn) lwRefreshBtn.addEventListener('click', ()=> fetchLiveWinsFromServer(12));

startLiveWinsPolling();

async function sendTradeToServer(username, result, amount){
  try{
    if(!username || typeof username !== 'string') {
      // try to resolve a username from storage
      username = (localStorage.getItem('kf_username') || sessionStorage.getItem('kf_username') || localStorage.getItem('kf_user_id') || '').toString();
      if(!username) return;
    }
    await fetch(`/api/user/${encodeURIComponent(username)}/trade`, {
      method: 'POST',
      headers: {'content-type': 'application/json'},
      body: JSON.stringify({ result, amount })
    });
  }catch(e){}
}


/* ---------------------------
   LEADERBOARD modal + nickname prompt
   - When saving a nickname, display: "Nickname set to {nick}"
   - Never display user_id as nickname (use "Anon" if none)
--------------------------- */




</script>




<!-- =========================
     FULL-SCREEN LEADERBOARD MODAL + NICKNAME PROMPT
   ========================= -->

<div id="kf-leaderboard-modal" class="modal-overlay" aria-hidden="true" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="kf-leaderboard-title">
    <div class="kf-leaderboard-hero" style="align-items:center">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:38px;height:38px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));display:flex;align-items:center;justify-content:center">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="var(--accent-green)" aria-hidden="true"><path d="M12 2l2.39 6.96L21 10.24l-5 3.65L17.78 22 12 18.27 6.22 22 8 13.89 3 10.24l6.61-1.28L12 2z"/></svg>
        </div>
        <h2 id="kf-leaderboard-title">LEADERBOARD</h2>
        <div style="width:38px;height:38px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));display:flex;align-items:center;justify-content:center">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="var(--accent-green)" aria-hidden="true"><path d="M12 2l2.39 6.96L21 10.24l-5 3.65L17.78 22 12 18.27 6.22 22 8 13.89 3 10.24l6.61-1.28L12 2z"/></svg>
        </div>
      </div>
      <div style="text-align:right">
        <div class="muted" id="kf-last-sync-main">—</div>
      </div>
    </div>

    <div class="kf-leaderboard-grid" style="margin-top:12px">
      <div class="kf-leaderboard-main">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted">Top 100 balances</div>
          <div style="display:flex;gap:8px">
            <input id="kf-nickname-main" type="text" placeholder="Enter nickname (max 40)" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
            <button id="kf-save-nick-main" class="btn" type="button">Save Nick</button>
            <button id="kf-refresh-main" class="small" type="button">Refresh</button>
          </div>
        </div>

        <table class="kf-table" role="table" aria-label="Leaderboard table" style="margin-top:12px">
          <thead>
            <tr>
              <th style="width:70%;">User</th>
              <th style="width:30%;">Win Rate</th>
            </tr>
          </thead>
          <tbody id="kf-table-body">
            <tr><td colspan="2" class="muted">Loading leaderboard...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="kf-leaderboard-right">
        <div style="font-weight:700">Monthly Podium</div>
        <div id="kf-podium-main" style="margin-top:8px"><div class="muted">Loading...</div></div>

        <div style="margin-top:12px;border-top:1px dashed rgba(255,255,255,0.04);padding-top:10px">
          <div class="muted">Your ID:</div>
          <div style="font-weight:800" id="kf-userid-main">—</div>
          <div class="muted" style="margin-top:8px">Your balance stored locally: <span id="kf-local-bal">—</span></div>
        </div>

        <div style="margin-top:12px">
          <button id="kf-close" class="small" type="button">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="kf-nickname-modal" class="modal-overlay" aria-hidden="true" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="kf-nick-title">
    <h3 id="kf-nick-title" style="color:var(--accent-green);margin:0 0 8px 0">Pick a nickname</h3>
    <p class="muted" style="margin:0 0 12px 0">This will be shown on the leaderboard. You will only be asked once.</p>
    <div style="display:flex;gap:8px">
      <input id="kf-nick-input" type="text" placeholder="Nickname" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
      <button id="kf-nick-save" class="btn" type="button">Save</button>
    </div>
    <div style="margin-top:12px"><button id="kf-nick-skip" class="small" type="button">Skip (ask me later)</button></div>
  </div>
</div>

<script>
/* Leaderboard modal script (updated to match column changes and podium no-winners message)
   - Uses /api endpoints (best-effort)
   - Renders the table in the modal (kf-table-body)
   - Keeps nickname modal separate.
   - When saving nickname shows toast "Nickname set to {nick}".
   - Wrapped in DOMContentLoaded so all elements are present and event wiring is reliable.
*/
document.addEventListener('DOMContentLoaded', function(){
  const API_BASE = '/api';
  const MAX_NICK_LEN = 40;

  const leaderboardBtn = document.getElementById('leaderboardBtn');
  const lbModal = document.getElementById('kf-leaderboard-modal');
  const lbClose = document.getElementById('kf-close');
  const lbTableBody = document.getElementById('kf-table-body');
  const podiumMain = document.getElementById('kf-podium-main');
  const lastSyncMain = document.getElementById('kf-last-sync-main');
  const refreshBtn = document.getElementById('kf-refresh-main');
  const nickInputMain = document.getElementById('kf-nickname-main');
  const saveNickMain = document.getElementById('kf-save-nick-main');
  const userIdEl = document.getElementById('kf-userid-main');
  const localBalEl = document.getElementById('kf-local-bal');

  const nickModal = document.getElementById('kf-nickname-modal');
  const nickModalInput = document.getElementById('kf-nick-input');
  const nickModalSave = document.getElementById('kf-nick-save');
  const nickModalSkip = document.getElementById('kf-nick-skip');

  // identity
  let userId = localStorage.getItem('kf_user_id');
  if(!userId){
    userId = 'u-' + Math.random().toString(36).slice(2,12);
    localStorage.setItem('kf_user_id', userId);
  }
  userIdEl.textContent = userId;

  let nickname = (localStorage.getItem('kf_nickname') || '').slice(0,MAX_NICK_LEN);
  if(nickname) nickInputMain.value = nickname;

  function showLbModal(show=true){
    if(show){
      lbModal.style.display = 'flex';
      lbModal.classList.add('active');
      lbModal.setAttribute('aria-hidden','false');
    } else {
      lbModal.classList.remove('active');
      lbModal.style.display = 'none';
      lbModal.setAttribute('aria-hidden','true');
    }
  }
  function showNickModal(show=true){
    if(show){
      nickModal.style.display = 'flex';
      nickModal.classList.add('active');
      nickModal.setAttribute('aria-hidden','false');
      nickModalInput.focus();
    } else {
      nickModal.classList.remove('active');
      nickModal.style.display = 'none';
      nickModal.setAttribute('aria-hidden','true');
    }
  }

  async function apiGet(path){
    try{
      const r = await fetch(API_BASE + path, { cache:'no-store' });
      if(!r.ok) throw new Error('Network');
      return await r.json();
    }catch(e){
      console.warn('apiGet', e);
      return null;
    }
  }
  async function apiPost(path,payload){
    try{
      const r = await fetch(API_BASE + path, {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error('Network');
      return await r.json();
    }catch(e){
      console.warn('apiPost', e);
      return null;
    }
  }

  // Format a single row into the table
  function insertTableRow(container, idx, user, isMe=false){
    const tr = document.createElement('tr');
    if(isMe) tr.className = 'me';
    const displayName = (user.nickname || '').trim() || 'Anon';
    const winRateVal = Number(user.performance ?? user.win_rate ?? 0);
    const perfClass = (winRateVal >= 0) ? 'kf-perf' : 'kf-perf negative';
    const initials = displayName.slice(0,2).toUpperCase();
    tr.innerHTML = `
      <td>
        <div class="kf-row-left">
          <div style="width:28px;color:var(--muted);text-align:right;font-weight:700">${idx+1}</div>
          <div class="kf-avatar" aria-hidden="true">${initials}</div>
          <div style="min-width:0">
            <div class="kf-username">${displayName}</div>
            <div class="kf-user-meta">${formatCurrency(Number(user.balance||0))}</div>
          </div>
        </div>
      </td>
      <td><div class="${perfClass}">${(winRateVal>=0?'+':'')}${winRateVal.toFixed(1)}%</div></td>
    `;
    container.appendChild(tr);
  }

  function renderLeaderboard(list){
    lbTableBody.innerHTML = '';
    if(!list || !Array.isArray(list) || list.length === 0){
      lbTableBody.innerHTML = '<tr><td colspan="2" class="muted">No leaderboard data yet.</td></tr>';
      return;
    }
    list.slice(0,100).forEach((u, idx) => {
      insertTableRow(lbTableBody, idx, u, u.user_id === userId);
    });
  }

  function renderPodium(month, p){
    podiumMain.innerHTML = '';
    if(!p || !Array.isArray(p) || p.length===0){
      podiumMain.innerHTML = '<div class="muted">No winners this month — check back by the end of the month to see</div>';
      return;
    }
    p.forEach(item=>{
      const r = document.createElement('div');
      r.style.display='flex'; r.style.justifyContent='space-between'; r.style.alignItems='center'; r.style.padding='6px';
      const displayName = (item.nickname || '').trim() || 'Anon';
      r.innerHTML = `<div style="font-weight:800">${item.position}. ${displayName}</div><div style="color:var(--muted)">${formatCurrency((item.balance||0))}</div>`;
      podiumMain.appendChild(r);
    });
    const m = document.createElement('div'); m.className='muted'; m.style.marginTop='6px'; m.textContent = `Month: ${month}`;
    podiumMain.appendChild(m);
  }

  function demoLeaderboard(){
    return [
      { user_id:'p1', nickname:'Player', balance:12000, performance:128.3, win_rate:36, trades:280 },
      { user_id:'p2', nickname:'Player', balance:11800, performance:120.1, win_rate:36, trades:280 },
      { user_id:'p3', nickname:'Player', balance:11600, performance:113.5, win_rate:36, trades:280 },
      { user_id:'p4', nickname:'Player', balance:11000, performance:102.2, win_rate:36, trades:280 },
      { user_id:'p5', nickname:'Player', balance:10500, performance:92.7, win_rate:36, trades:280 },
      { user_id:'p6', nickname:'Player', balance:9800, performance:82.3, win_rate:36, trades:280 },
      { user_id:'p7', nickname:'Player', balance:9200, performance:72.8, win_rate:36, trades:280 },
      { user_id:'p8', nickname:'Player', balance:8600, performance:63.1, win_rate:36, trades:280 },
      { user_id:'p9', nickname:'Player', balance:8000, performance:54.0, win_rate:36, trades:280 },
      { user_id:'p10', nickname:'Player', balance:7400, performance:45.2, win_rate:36, trades:280 },
    ];
  }

  async function refreshAll(){
    lastSyncMain.textContent = '...';
    const lb = await apiGet('/leaderboard?limit=100');
    if(lb && Array.isArray(lb.leaderboard)){
      renderLeaderboard(lb.leaderboard);
    } else {
      renderLeaderboard(demoLeaderboard());
    }

    const winners = await apiGet('/winners');
    if(winners && winners.latest){
      renderPodium(winners.latest, winners.winners && winners.winners.podium ? winners.winners.podium : []);
    } else {
      renderPodium(null, []);
    }

    lastSyncMain.textContent = new Date().toLocaleTimeString();
  }

    async function saveUserState(nick, bal){
        try {
            const usernameFromStorage = (localStorage.getItem('kf_username') || sessionStorage.getItem('kf_username') || '').trim();
            const usernameFallback = (typeof userId !== 'undefined' && userId) ? userId : (localStorage.getItem('kf_user_id') || sessionStorage.getItem('kf_user_id') || '');
            const username = usernameFromStorage || usernameFallback || ('guest-' + Math.random().toString(36).slice(2,10));

            const payload = {};
            if (nick !== undefined) payload.nickname = (nick || '').slice(0, MAX_NICK_LEN);
            if (bal !== undefined) payload.balance = Number(bal);

            const res = await apiPost(`/user/${encodeURIComponent(username)}`, payload);
            return res;
        } catch (e) {
            console.warn('saveUserState failed', e);
            return null;
        }
    }


try{
  if(window.setBalance && typeof window.setBalance === 'function'){
    const _orig = window.setBalance.bind(window);
    window.setBalance = function(v){
      _orig(v);
      // use numeric window.balance (not formatted DOM text)
      const balNow = Number(window.balance);
      if(!isFinite(balNow)) return;
      try{ localStorage.setItem('kf_balance', String(balNow)); }catch(e){}
      // save to server (non-blocking) using proper numeric value
      saveUserState(localStorage.getItem('kf_nickname') || '', balNow);
      setTimeout(()=>{ refreshAll(); }, 800);
    };
  }
}catch(e){ console.warn('wrap setBalance failed', e); }


(async function init(){
  nickname = (localStorage.getItem('kf_nickname') || '').slice(0,MAX_NICK_LEN);
  if(nickname){
    nickInputMain.value = nickname;
    nickModalInput.value = nickname;
  }

  const serverUser = await apiGet(`/user/${encodeURIComponent(userId)}`);
  if(serverUser && serverUser.user_id){
    if(serverUser.nickname){
      nickname = serverUser.nickname.slice(0,MAX_NICK_LEN);
      localStorage.setItem('kf_nickname', nickname);
      nickInputMain.value = nickname;
      nickModalInput.value = nickname;
    }
    if(typeof serverUser.balance !== 'undefined' && isFinite(Number(serverUser.balance))){
      try{
        if(window.setBalance && typeof window.setBalance === 'function'){
          window.setBalance(Number(serverUser.balance));
        } else {
          setBalance(Number(serverUser.balance));
        }
      }catch(e){}
    }
  } else {
    // use numeric local storage if present, else keep current window.balance
    const localBal = localStorage.getItem('kf_balance');
    if(localBal !== null && isFinite(Number(localBal))){
      try{
        if(window.setBalance && typeof window.setBalance === 'function'){
          window.setBalance(Number(localBal));
        } else {
          setBalance(Number(localBal));
        }
      }catch(e){}
    } else {
      // ensure we persist the in-memory balance (fallback)
      try{ localStorage.setItem('kf_balance', String(Number(window.balance || INITIAL_BALANCE))); }catch(e){}
    }
    // save known nickname + numeric balance to server (best-effort)
    try { saveUserState(nickname || '', Number(window.balance || INITIAL_BALANCE)); } catch(e){}
  }

  localBalEl.textContent = formatCurrency(Number(localStorage.getItem('kf_balance') || Number(window.balance || 0)));

  const seenNick = !!localStorage.getItem('kf_nickname');
  if(!seenNick){
    showNickModal(true);
  }

  await refreshAll();
  setInterval(refreshAll, 15000);
})();

  // UI events
  if(leaderboardBtn) leaderboardBtn.addEventListener('click', ()=> showLbModal(true));
  if(lbClose) lbClose.addEventListener('click', ()=> showLbModal(false));
  if(refreshBtn) refreshBtn.addEventListener('click', ()=> refreshAll());

  if(saveNickMain) saveNickMain.addEventListener('click', async ()=>{
    const v = (nickInputMain.value || '').trim().slice(0,MAX_NICK_LEN);
    if(!v) return alert('Enter a nickname (max 40 chars)');
    nickname = v;
    localStorage.setItem('kf_nickname', nickname);
    nickModalInput.value = nickname;
    nickInputMain.value = nickname;
    const res = await saveUserState(nickname, Number(window.balance || 0));
    // show confirmation toast
    showToast(`Nickname set to ${nickname}`);
    // refresh leaderboard after save
    setTimeout(()=> refreshAll(), 600);
  });

  if(nickModalSave) nickModalSave.addEventListener('click', async ()=>{
    const v = (nickModalInput.value || '').trim().slice(0,MAX_NICK_LEN);
    if(!v) return alert('Enter a nickname (max 40 chars)');
    nickname = v;
    localStorage.setItem('kf_nickname', nickname);
    const res = await saveUserState(nickname, Number(window.balance || 0));
    showToast(`Nickname set to ${nickname}`);
    showNickModal(false);
    refreshAll();
  });
  if(nickModalSkip) nickModalSkip.addEventListener('click', ()=>{
    localStorage.setItem('kf_nickname_skipped', '1');
    showNickModal(false);
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      if(lbModal.style.display === 'flex') showLbModal(false);
      if(nickModal.style.display === 'flex') showNickModal(false);
    }
  });

  // Expose small helper for other UI (if other scripts call it)
  window.__kf_showLeaderboard = () => showLbModal(true);
});
</script>
<script>
/* Unified Rainbet modal wiring — paste this once at the end of <body> */
(function(){
  // run after DOM ready
  function ready(fn){
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }

  ready(function(){
    const rainBtn = document.getElementById('rainbetBtn');
    const rainModal = document.getElementById('rainbetModal');
    const rainClose = document.getElementById('rainCloseBtn');

    if(!rainBtn || !rainModal){
      console.warn('rain: missing elements', { rainBtn: !!rainBtn, rainModal: !!rainModal });
      return;
    }

    // helper open/close
    function openRain(){
      // defensively remove duplicates
      try { rainModal.classList.add('active'); } catch(e){ /* ignore */ }
      rainModal.style.display = 'flex';
      rainModal.setAttribute('aria-hidden', 'false');
      // optional: prevent body scroll while modal open
      document.documentElement.style.overflow = 'hidden';
    }
    function closeRain(){
      rainModal.classList.remove('active');
      rainModal.style.display = 'none';
      rainModal.setAttribute('aria-hidden', 'true');
      document.documentElement.style.overflow = '';
    }

    // remove previously-attached helper handlers if present
    try {
      if (rainBtn._kf_rain_handler) rainBtn.removeEventListener('click', rainBtn._kf_rain_handler);
    } catch(e){}

    const handler = function(ev){
      try{ ev && ev.preventDefault && ev.preventDefault(); }catch(e){}
      openRain();
    };
    rainBtn.addEventListener('click', handler);
    rainBtn._kf_rain_handler = handler;

    // close button
    if(rainClose){
      try { if(rainClose._kf_rain_close) rainClose.removeEventListener('click', rainClose._kf_rain_close); } catch(e){}
      const ch = function(ev){ ev && ev.preventDefault && ev.preventDefault(); closeRain(); };
      rainClose.addEventListener('click', ch);
      rainClose._kf_rain_close = ch;
    }

    // backdrop click
    rainModal.addEventListener('click', function(ev){
      if(ev.target === rainModal) closeRain();
    });

    // Escape key
    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && rainModal.classList.contains('active')) closeRain();
    });

    // ensure initial state
    if(!rainModal.classList.contains('active')) rainModal.setAttribute('aria-hidden','true');
  });
})();
</script>
</body>
</html>
